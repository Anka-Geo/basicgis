!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.AnkaScalable=e():t.AnkaScalable=e()}(window,(function(){return function(t){var e={};function i(n){if(e[n])return e[n].exports;var o=e[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(n,o,function(e){return t[e]}.bind(null,o));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=9)}([,,function(t,e){var i,n;THREE.LineSegmentsGeometry=function(){THREE.InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.addAttribute("position",new THREE.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.addAttribute("uv",new THREE.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))},THREE.LineSegmentsGeometry.prototype=Object.assign(Object.create(THREE.InstancedBufferGeometry.prototype),{constructor:THREE.LineSegmentsGeometry,isLineSegmentsGeometry:!0,applyMatrix:function(t){var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(i),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new THREE.InstancedInterleavedBuffer(e,6,1);return this.addAttribute("instanceStart",new THREE.InterleavedBufferAttribute(i,3,0)),this.addAttribute("instanceEnd",new THREE.InterleavedBufferAttribute(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var i=new THREE.InstancedInterleavedBuffer(e,6,1);return this.addAttribute("instanceColorStart",new THREE.InterleavedBufferAttribute(i,3,0)),this.addAttribute("instanceColorEnd",new THREE.InterleavedBufferAttribute(i,3,3)),this},fromWireframeGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromEdgesGeometry:function(t){return this.setPositions(t.attributes.position.array),this},fromMesh:function(t){return this.fromWireframeGeometry(new THREE.WireframeGeometry(t.geometry)),this},fromLineSegements:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},computeBoundingBox:(n=new THREE.Box3,function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;void 0!==t&&void 0!==e&&(this.boundingBox.setFromBufferAttribute(t),n.setFromBufferAttribute(e),this.boundingBox.union(n))}),computeBoundingSphere:(i=new THREE.Vector3,function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(void 0!==t&&void 0!==e){var n=this.boundingSphere.center;this.boundingBox.getCenter(n);for(var o=0,a=0,s=t.count;a<s;a++)i.fromBufferAttribute(t,a),o=Math.max(o,n.distanceToSquared(i)),i.fromBufferAttribute(e,a),o=Math.max(o,n.distanceToSquared(i));this.boundingSphere.radius=Math.sqrt(o),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}),toJSON:function(){},clone:function(){},copy:function(t){return this}})},function(t,e){THREE.LineGeometry=function(){THREE.LineSegmentsGeometry.call(this),this.type="LineGeometry"},THREE.LineGeometry.prototype=Object.assign(Object.create(THREE.LineSegmentsGeometry.prototype),{constructor:THREE.LineGeometry,isLineGeometry:!0,setPositions:function(t){for(var e=t.length-3,i=new Float32Array(2*e),n=0;n<e;n+=3)i[2*n]=t[n],i[2*n+1]=t[n+1],i[2*n+2]=t[n+2],i[2*n+3]=t[n+3],i[2*n+4]=t[n+4],i[2*n+5]=t[n+5];return THREE.LineSegmentsGeometry.prototype.setPositions.call(this,i),this},setColors:function(t){for(var e=t.length-3,i=new Float32Array(2*e),n=0;n<e;n+=3)i[2*n]=t[n],i[2*n+1]=t[n+1],i[2*n+2]=t[n+2],i[2*n+3]=t[n+3],i[2*n+4]=t[n+4],i[2*n+5]=t[n+5];return THREE.LineSegmentsGeometry.prototype.setColors.call(this,i),this},fromLine:function(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this},copy:function(t){return this}})},function(t,e){var i,n;THREE.LineSegments2=function(t,e){THREE.Mesh.call(this),this.type="LineSegments2",this.geometry=void 0!==t?t:new THREE.LineSegmentsGeometry,this.material=void 0!==e?e:new THREE.LineMaterial({color:16777215*Math.random()})},THREE.LineSegments2.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:THREE.LineSegments2,isLineSegments2:!0,computeLineDistances:(i=new THREE.Vector3,n=new THREE.Vector3,function(){for(var t=this.geometry,e=t.attributes.instanceStart,o=t.attributes.instanceEnd,a=new Float32Array(2*e.data.count),s=0,r=0,l=e.data.count;s<l;s++,r+=2)i.fromBufferAttribute(e,s),n.fromBufferAttribute(o,s),a[r]=0===r?0:a[r-1],a[r+1]=a[r]+i.distanceTo(n);var h=new THREE.InstancedInterleavedBuffer(a,2,1);return t.addAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(h,1,0)),t.addAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(h,1,1)),this}),copy:function(t){return this}})},function(t,e){THREE.UniformsLib.line={linewidth:{value:1},resolution:{value:new THREE.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},THREE.ShaderLib.line={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"},THREE.LineMaterial=function(t){THREE.ShaderMaterial.call(this,{type:"LineMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.line.uniforms),vertexShader:THREE.ShaderLib.line.vertexShader,fragmentShader:THREE.ShaderLib.line.fragmentShader}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)},THREE.LineMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),THREE.LineMaterial.prototype.constructor=THREE.LineMaterial,THREE.LineMaterial.prototype.isLineMaterial=!0,THREE.LineMaterial.prototype.copy=function(t){return THREE.ShaderMaterial.prototype.copy.call(this,t),this.color.copy(t.color),this.linewidth=t.linewidth,this.resolution=t.resolution,this}},function(t,e){THREE.Line2=function(t,e){THREE.LineSegments2.call(this),this.type="Line2",this.geometry=void 0!==t?t:new THREE.LineGeometry,this.material=void 0!==e?e:new THREE.LineMaterial({color:16777215*Math.random()})},THREE.Line2.prototype=Object.assign(Object.create(THREE.LineSegments2.prototype),{constructor:THREE.Line2,isLine2:!0,copy:function(t){return this}})},,,function(t,e,i){"use strict";i.r(e),i.d(e,"Layer",(function(){return ht})),i.d(e,"AjaxLayer",(function(){return St})),i.d(e,"ArcGISFeatureLayer",(function(){return Pt})),i.d(e,"GeoServerWFSLayer",(function(){return Ot})),i.d(e,"SGeom",(function(){return T})),i.d(e,"SPoint",(function(){return w})),i.d(e,"SPolygon",(function(){return k})),i.d(e,"SHLine",(function(){return kt})),i.d(e,"SLine",(function(){return G})),i.d(e,"SMultiLine",(function(){return q})),i.d(e,"SMultiPoint",(function(){return et})),i.d(e,"SMultiPolygon",(function(){return K})),i.d(e,"WallGeometry",(function(){return rt})),i.d(e,"GeomDataHolder",(function(){return st})),i.d(e,"EventMesh",(function(){return a})),i.d(e,"EventLine",(function(){return D})),i.d(e,"ScalablePlugin",(function(){return wt})),i.d(e,"GeometryObserver",(function(){return Tt})),i.d(e,"SketchLayer",(function(){return ct})),a.prototype=Object.create(THREE.Mesh.prototype);var n=Object.create(AnkaPanAPI.Base.prototype);for(var o in n)a.prototype[o]=n[o];function a(){AnkaPanAPI.Base.apply(this,[]),THREE.Mesh.apply(this,arguments),this.userData.clickPriority=1}a.prototype.constructor=a,T.prototype=Object.create(THREE.Object3D.prototype);var s,r,l,h,c,u,p,f,d,y,m,g,v,b,_=Object.create(AnkaPanAPI.Base.prototype);for(var E in _)T.prototype[E]=_[E];function T(t,e){this._isSelected=!1,this.points=[],this.attributes={},this.userData={},AnkaPanAPI.Base.apply(this,[]),THREE.Object3D.apply(this,arguments),this.setCommonGeom(e)}function w(t){if(this.type="Point",this.softText=t.softText,!w.__hookTexture){var e=r.getInstance().GetAssetNoCache("img/scalable/hook.jpg");e.generateMipmaps=!1,e.minFilter=THREE.LinearFilter,w.__hookTexture=e}if(!w.__hookGeom){var i=new c,n=new h;i.vertices.push(n),w.__hookGeom=i}var o=new u({size:8,sizeAttenuation:!1,map:w.__hookTexture,depthTest:!0,depthWrite:!0,transparent:!0});this.hookMaterial=o,this.iconGeom=w.__iconGeom,this.hookGeom=w.__hookGeom,this.scalable=t,T.apply(this,arguments)}function S(t){THREE.BufferGeometry.call(this),this.points=t,this.createBufferPlaneGeometry()}T.prototype.constructor=T,T.CLICK="click",T.MOUSE_DOWN="onMouseDown",T.prototype.updateByGeom=function(t){console.log("updateByGeom is not implemented")},T.prototype.updateStyle=function(t){console.log("updateStyle is not implemented")},T.prototype.getOpacity=function(){return this.__layer?this.__layer.getOpacity():1},T.prototype.setCommonGeom=function(t){t instanceof st?this._commonGeom=t:console.error("Cannot be created without commongeom")},T.prototype.getLabelText=function(){if(this.__layer&&!this.__layer.isSketchLayer)return this.__layer.getLabelText(this);if(this.__layer){var t=this.__layer.getLabelText(this);if(null!=t&&t.length>0)return t}var e=this._commonGeom;if(e.type===st.POINT){if(e.attributes){var i=e.attributes;if(void 0!==i._lon){var n=parseFloat(i._lon).toFixed(6),o=parseFloat(i._lat).toFixed(6),a=parseFloat(i._alt).toFixed(3);return 0===parseInt(i._alt)?n+", "+o:n+", "+o+", "+a}}}else{if(e.type===st.LINE)return e.attributes._length;if(e.type===st.POLYGON)return e.attributes._areaSize;if(e.attributes.hasOwnProperty("_length"))return e.attributes._length;console.log("Unnown type")}},T.prototype.getCommonGeom=function(){return this._commonGeom},T.prototype.onDown=function(t){t.currentTarget=this,this.throwEvent(t)},T.prototype.update=function(){console.log("Need to be override")},T.prototype.getAttributes=function(){return this.attributes},T.prototype.isSelected=function(){return this._isSelected},T.prototype.setLayer=function(t){this.__layer=t},T.prototype.destroy=function(){console.log("destroy not implemented")},T.prototype.setDynamicPoint=function(){console.log("setDynamicPoint not implemented")},T.prototype.setPoints=function(t){console.log("setPoints not implemented")},T.prototype.setData=function(t,e){console.log("setData not implemented")},T.prototype.setSelection=function(t){this._isSelected!==t&&(this._isSelected=t,t?this.onSelect():this.onDeSelect())},T.prototype.onSelect=function(){console.log("need to be overrrided")},T.prototype.onDeSelect=function(){console.log("need to be overrrided")},window.AnkaPanAPI?((s=window.AnkaPanAPI).PanoGL,l=s.Base,r=s.AssetManager):console.error("AnkaPanAPI could not be found"),window.THREE?(h=THREE.Vector3,c=THREE.Geometry,u=THREE.PointsMaterial,p=THREE.PlaneBufferGeometry,d=THREE.Texture,f=THREE.Points,y=THREE.LinearFilter,m=THREE.Color):console.error("THREE could not be found"),w.isMultiGeom=!1,w.prototype=Object.assign(Object.create(T.prototype),{constructor:w,reset:function(){this.update(),this.lookAt(new h(0,this.position.y,0))},onClick:function(t){t.currentTarget=this,this.throwEvent(t)},onSelect:function(){this.icon.material.color=new m(65535)},setPoints:function(t){var e=t[0],i=e.lon,n=e.lat,o=e.alt;this.setLocation(i,n,o),this.reset()},stopDraw:function(){this.update()},setDynamicPoint:function(){},setData:function(t,e){if(this.attributes=e,t.length>0){var i=t[0],n=i.lon,o=i.lat,a=i.alt;this.setLocation(n,o,a),this.visible=!0}else this.visible=!1},onDeSelect:function(){this.icon.material.color=new m(16777215)},enable:function(t,e){if(this.panogl=t,!this.enabled){this.icon||(this.hookMesh=new f(this.hookGeom,this.hookMaterial),this.add(this.hookMesh))}},updateStyle:function(){if(this.__layer){this.icon&&(this.icon.material.dispose(),this.icon.setClickable(!1),this.icon.parent&&this.icon.parent.remove(this.icon)),this.hookMesh&&(this.hookMesh.material.opacity=this.getOpacity());var t=this.__layer.getStyle(this);t.texture||function(t){if(!g){(g=document.createElement("canvas")).width=16,g.height=16;var e=g.getContext("2d");e.fillStyle="#ffffff",e.fillRect(0,0,16,16),g.style.top="0px"}v||(v=new d(g)),b||(b=new p(16,16,1,1)),t.texture=v,t.xoffset=0,t.yoffset=0,t.geometry=b}(t);var e=t.texture;if(e){e.needsUpdate=!0;var i=t.geometry,n=new THREE.MeshBasicMaterial({map:e,color:16777215,transparent:!0,alphaTest:.2});this.icon=new a(i,n),this.icon.material.opacity=this.getOpacity(),this.add(this.icon);var o=this.panogl,s=o.getMainCamera();this.icon.setClickable(!0,o,null,s),this.icon.position.set(t.xoffset,t.yoffset,-1),this.icon.addEvent(T.CLICK,this,this.onClick),this.icon.addEvent(T.MOUSE_DOWN,this,this.onDown)}}},update:function(){null!=this.lon&&null!=this.lat&&(this.setLocation(this.lon,this.lat,this.alt),this.lookAt(new h(0,this.position.y,0)),this.setLabel())},setLabel:function(){var t=this.softText;if(!this.__layer||this.__layer.getLabelVisibility()){if(!this.labelHook){this.labelHook=new THREE.Object3D,this.add(this.labelHook);var e=this.panogl.getMainCamera(),i=isNaN(this.alt)||!this.alt?"0":this.alt.toFixed(6),n=this._commonGeom;n.attributes._lon=this.lon,n.attributes._lat=this.lat,n.attributes._alt=i;var o=this.getLabelText();t&&t.addObject3D(this.labelHook,e,o)}}else this.labelHook&&(t&&t.removeObject3D(this.labelHook),this.remove(this.labelHook),this.labelHook=null)},setLocation:function(t,e,i){this.lat=e,this.lon=t,this.alt=i;var n=this.scalable.calculatePointPositionFromLonLatAlt(t,e,i),o=isNaN(this.alt)||!this.alt?"0":this.alt.toFixed(6);this.attributes.___location="lon:"+this.lon.toFixed(6)+" lat:"+this.lat.toFixed(6)+" alt:"+this.alt,this.points[0]={lon:t,lat:e,alt:o},this.position.set(n.x,n.y,n.z)},disableAll:function(){this.icon&&this.icon.setClickable(!1),this.parent&&this.parent.remove(this),this.enabled=!1},destroy:function(){if(this.disableAll(),this.icon&&(this.icon.geometry&&this.icon.geometry.dispose(),this.icon.material&&this.icon.material.dispose()),this.hookMesh&&this.hookMesh.material&&this.hookMesh.material.dispose(),this.labelHook){var t=this.softText;t&&t.removeObject3D(this.labelHook),this.softText=null,this.labelHook=null}}}),S.prototype=Object.assign(Object.create(THREE.BufferGeometry.prototype),{constructor:S,createBufferPlaneGeometry:function(){for(var t=[],e=[],i=0,n=Math.PI/2,o=this.points.length-1,a=[],s=0;s<o;s++){var r=this.points[s],l=this.points[s+1],h=r.x-l.x,c=r.z-l.z,u=1024/3*.125,p=Math.sqrt(h*h+c*c)/(1024/3);p<1&&(u*=p,p=1),h=r.x-l.x,c=r.z-l.z;var f=Math.atan2(h,c),d=r.x+Math.sin(f+n)*u,y=r.z+Math.cos(f+n)*u,m=r.x+Math.sin(f-n)*u,g=r.z+Math.cos(f-n)*u,v=l.x+Math.sin(f+n)*u,b=l.z+Math.cos(f+n)*u,_=l.x+Math.sin(f-n)*u,E=l.z+Math.cos(f-n)*u;t.push(_,l.y,E),t.push(v,l.y,b),t.push(d,r.y,y),t.push(m,r.y,g);var T=i,w=i+1,S=i+2,P=i+3;i+=4,e.push(S,w,T),e.push(T,P,S);var M=p;a.push(M,1),a.push(M,0),a.push(0,0),a.push(0,1)}this.addAttribute("position",new THREE.Float32BufferAttribute(t,3)),this.addAttribute("uv",new THREE.Float32BufferAttribute(a,2));var D=new Uint16Array(e);return this.setIndex(new THREE.BufferAttribute(D,1)),this.setDrawRange(0,100),this.attributes.position.needsUpdate=!0,this.attributes.uv.needsUpdate=!0,this}}),D.prototype=Object.create(THREE.Line.prototype);var P=Object.create(AnkaPanAPI.Base.prototype);for(var M in P)D.prototype[M]=P[M];function D(){AnkaPanAPI.Base.apply(this,[]),THREE.Line.apply(this,arguments),this.userData.clickPriority=1}function H(t){return(H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function C(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function A(t,e){return(A=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function x(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,n=L(t);if(e){var o=L(this).constructor;i=Reflect.construct(n,arguments,o)}else i=n.apply(this,arguments);return R(this,i)}}function R(t,e){if(e&&("object"===H(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function L(t){return(L=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}D.prototype.constructor=D;var G=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&A(t,e)}(a,t);var e,i,n,o=x(a);function a(t,e){var i;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,a),(i=o.call(this,void 0,e)).points=[],i.canDraw=!0,i.scalable=t,i.softText=t.softText,i.opacity=.7,i.labelHook=new THREE.Object3D,i._lineColor=new THREE.Color(1,0,1),i.material=new THREE.LineMaterial({color:i._lineColor,linewidth:5,dashed:!0,depthTest:!0,transparent:!0,depthWrite:!1}),i._vertexPointMaterial=new THREE.PointsMaterial({color:16777215,size:5,depthWrite:!1,depthTest:!1,opacity:1,transparent:!0,sizeAttenuation:!1}),t.getBasePano().addResizeMaterial(i.material),i}return e=a,(i=[{key:"type",get:function(){return"Line"}},{key:"reset",value:function(){}},{key:"createLine",value:function(t){if(this.destroyLine(),t.length>0){var e=new THREE.BufferGeometry;e.addAttribute("position",new THREE.BufferAttribute(new Float32Array(t),3));var i=new THREE.Points(e,this._vertexPointMaterial);this.add(i),this.vertexPoints=i}if(t.length>3){var n=new THREE.LineGeometry,o=new THREE.Line2(n,this.material);o.name="SLine_çizim",o.frustumCulled=!1,o.geometry.setPositions(t),o.computeLineDistances(),this.add(o),this.line=o,this._vertices=t}}},{key:"enable",value:function(){this.enabled||(this.openGeom=!0,this.canDraw=!0,this.enabled=!0)}},{key:"stopDraw",value:function(){this.openGeom=!1,this.dynamicPoint=null;var t=this.line;t&&(t.frustumCulled=!1),this.setLabel()}},{key:"setLabel",value:function(){this.destroyLabel();var t=this.__layer;if(!t||t.getLabelVisibility()){if(!this.openGeom){for(var e=0,i=0;i<this.points.length-1;i++){var n=this.points[i],o=this.points[i+1],a=AnkaPanAPI.Utils.haversine(n.lat,o.lat,n.lon,o.lon),s=isNaN(n.alt)||void 0===n.alt||null==n.alt?0:n.alt,r=isNaN(o.alt)||void 0===o.alt||null==o.alt?0:o.alt;if(s!==r){var l=s-r;a=Math.sqrt(l*l+a*a)}e+=a}var h=this.getCentroid(),c=this.scalable.getBasePano().getMainCamera();this.labelHook.position.set(h.x,h.y,h.z),this.labelHook.name="hook",this.add(this.labelHook),this._commonGeom.attributes._length=Math.round(100*e)/100+"m",t&&t.isLabelOnLine?this.createGroundLabel(this.getLabelText()):this.softText&&this.softText.addObject3D(this.labelHook,c,this.getLabelText())}}else this.labelHook&&this.softText&&this.softText.removeObject3D(this.labelHook)}},{key:"getLength",value:function(){for(var t=0,e=0;e<this.points.length-1;e++){var i=this.points[e],n=this.points[e+1],o=AnkaPanAPI.Utils.haversine(i.lat,n.lat,i.lon,n.lon),a=isNaN(i.alt)||void 0===i.alt||null==i.alt?0:i.alt,s=isNaN(n.alt)||void 0===n.alt||null==n.alt?0:n.alt;if(a!==s){var r=a-s;o=Math.sqrt(r*r+o*o)}t+=o}return t}},{key:"createGroundLabel",value:function(t){for(var e=[],i=0;i<this.points.length;i++){var n=this.points[i],o=this.scalable.calculatePointPositionFromLonLatAlt(n.lon,n.lat,n.alt);e.push(new THREE.Vector3(o.x,o.y,o.z))}var a=AnkaPanAPI.Utils.createTextTextureForGround(t).texture;a.generateMipmaps=!1,a.minFilter=THREE.LinearFilter,a.magFilter=THREE.LinearFilter,a.wrapS=a.wrapT=THREE.RepeatWrapping;var s=new THREE.MeshBasicMaterial({map:a,transparent:!0,alphaTest:0,depthWrite:!1,depthTest:!1}),r=new S(e);this.groundLabel=new THREE.Mesh(r,s),this.groundLabel.name="ground_label",this.add(this.groundLabel)}},{key:"getCentroid",value:function(){for(var t=this.points,e=Number.MAX_SAFE_INTEGER,i=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER,s=Number.MIN_SAFE_INTEGER,r=0;r<t.length;r++){var l=t[r],h=this.scalable.calculatePointPositionFromLonLatAlt(l.lon,l.lat,l.alt);h.x<e&&(e=h.x),h.x>o&&(o=h.x),h.z<n&&(n=h.z),h.z>s&&(s=h.z),h.y<i&&(i=h.y),h.y>a&&(a=h.y)}return{x:e+(o-e)/2,y:i+(a-i)/2,z:n+(s-n)/2}}},{key:"onClick",value:function(t){t.currentTarget=this,this.throwEvent(t)}},{key:"setDynamicPoint",value:function(t){this.points.length>0&&(this.dynamicPoint={lon:t.lon,lat:t.lat,alt:t.alt})}},{key:"setPoints",value:function(t){this.points=t.concat()}},{key:"setData",value:function(t,e){this.attributes=e,this.points.length=0;for(var i=0;i<t.length;i++)this.points.push(t[i])}},{key:"addPoint",value:function(t,e,i){this.points.push({lon:t,lat:e,alt:i})}},{key:"onSelect",value:function(){this.line.material.color=new THREE.Color(0,1,1)}},{key:"onDeSelect",value:function(){this.__layer?this.updateStyle():this.line.material.color=new THREE.Color(this._lineColor)}},{key:"updateStyle",value:function(){if(this.__layer){var t=this.material,e=this.__layer.getStyle(this);t.color=new THREE.Color(e.lineColor);var i=e.lineOpacity*this.getOpacity();isNaN(i)&&(i=1),t.opacity=i,this._vertexPointMaterial.opacity=i,t.linewidth=e.lineWidth}}},{key:"createIntersectLine",value:function(){this.destroyIntersectLine();var t=new THREE.LineBasicMaterial({color:new THREE.Color(1,1,0),linewidth:1,depthTest:!0,opacity:0,transparent:!0,depthWrite:!1}),e=this._vertices,i=new THREE.BufferGeometry,n=new Float32Array(e);i.addAttribute("position",new THREE.BufferAttribute(n,3));var o=new D(i,t);o.name="SLine_çizim",o.frustumCulled=!1,o.geometry.computeBoundingSphere();var a=this.scalable.getBasePano(),s=a.getMainCamera();o.setClickable(!0,a,null,s),o.addEvent(T.CLICK,this,this.onClick),o.addEvent(T.MOUSE_DOWN,this,this.onDown),this.add(o),this._intersectLine=o}},{key:"update",value:function(){var t=this;this.position.set(0,0,0);var e=this.points,i=[];if(e.forEach((function(e){var n=t.scalable.calculatePointPositionFromLonLatAlt(e.lon,e.lat,e.alt);i.push(n.x,n.y,n.z)})),this.dynamicPoint){var n=this.dynamicPoint,o=this.scalable.calculatePointPositionFromLonLatAlt(n.lon,n.lat,n.alt);i.push(o.x,o.y,o.z)}this.createLine(i),this.createIntersectLine(),this.setLabel()}},{key:"disableAll",value:function(){this.parent&&this.parent.remove(this),this.enabled=!1}},{key:"destroyIntersectLine",value:function(){var t=this._intersectLine;t&&(t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose(),t.parent&&t.parent.remove(t),t.setClickable(!1),t=void 0),this._intersectLine=void 0}},{key:"destroyLabel",value:function(){this.softText&&this.labelHook&&this.softText.removeObject3D(this.labelHook)}},{key:"destroyLine",value:function(){var t=this.line;t&&(this.remove(t),t.geometry.dispose());var e=this.vertexPoints;e&&(this.remove(e),e.geometry.dispose(),e.material.dispose())}},{key:"destroy",value:function(){this.disableAll(),this.destroyLabel(),this.destroyIntersectLine(),this.material&&(this.scalable.getBasePano().removeResizeMaterial(this.material),this.material.dispose()),this.line&&(this.line.geometry&&this.line.geometry.dispose(),this.line.material&&this.line.material.dispose()),this.groundLabel&&(this.groundLabel.geometry.dispose(),this.groundLabel.material.map.dispose(),this.groundLabel.material.dispose(),this.groundLabel.parent.remove(this.groundLabel))}}])&&C(e.prototype,i),n&&C(e,n),Object.defineProperty(e,"prototype",{writable:!1}),a}(T);G.isMultiGeom=!1,k.isMultiGeom=!1;var O=new THREE.PointsMaterial({color:16777215,size:5,depthWrite:!1,depthTest:!1,sizeAttenuation:!1});function k(t,e){T.apply(this,arguments),this.points=[],this.type="Polygon",this._lineColor=255,this.canDraw=!0,this.scalable=t,this.softText=t.softText,this.opacity=.7,this.labelHook=new THREE.Object3D;var i=new THREE.LineBasicMaterial({color:this._lineColor,linewidth:1,depthTest:!0,transparent:!0,side:THREE.DoubleSide,depthWrite:!1});this.material=i;var n=200,o=new THREE.BufferGeometry,s=new Float32Array(3*n);o.addAttribute("position",new THREE.BufferAttribute(s,3)),this.line=new THREE.Line(o,i),this.line.frustumCulled=!1,this._fillColor=Math.round(16777215*Math.random());var r=new THREE.MeshBasicMaterial({color:this._fillColor,depthTest:!0,transparent:!0,opacity:this.opacity,depthWrite:!1,side:THREE.DoubleSide}),l=new Float32Array(3*n),h=new Float32Array(3*n),c=new Uint16Array(n),u=new THREE.BufferGeometry;u.addAttribute("position",new THREE.BufferAttribute(l,3)),u.addAttribute("nomal",new THREE.BufferAttribute(h,3)),u.setIndex(new THREE.BufferAttribute(c,1)),this.fill=new a(u,r),this.fill.frustumCulled=!1,this.add(this.fill),u.setDrawRange(0,3),this.add(this.line)}function I(t){return(I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function j(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function N(t,e){return(N=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function F(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,n=B(t);if(e){var o=B(this).constructor;i=Reflect.construct(n,arguments,o)}else i=n.apply(this,arguments);return z(this,i)}}function z(t,e){if(e&&("object"===I(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function B(t){return(B=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}k.prototype=Object.assign(Object.create(T.prototype),{constructor:k,reset:function(){this.lookAt(new THREE.Vector3(0,this.position.y,0))},enable:function(t,e){if(!this.enabled){this.openGeom=!0,this.panogl=t;var i=t.getMainCamera();this.fill.setClickable(!0,t,null,i),this.fill.addEvent(T.CLICK,this,this.onClick),this.fill.addEvent(T.MOUSE_DOWN,this,this.onDown)}},stopDraw:function(){this.openGeom=!1;var t=this.points[0];this.points.push(t),this.dynamicPoint=null,this.line.frustumCulled=!0,this.fill.frustumCulled=!0,this.update()},setDynamicPoint:function(t){this.points.length>0&&(this.dynamicPoint={lon:t.lon,lat:t.lat,alt:t.alt})},setData:function(t,e,i){var n;for(this.attributes=e,this.points.length=0,n=0;n<t.length;n++)this.points.push(t[n]);if(this.holes=[],i)for(n=0;n<i.length;n++){for(var o=[],a=i[n],s=0;s<a.length;s++)o.push(a[s]);this.holes.push(o)}this.line.frustumCulled=!1,this.fill.frustumCulled=!1},calculateArea:function(t){if(t){for(var e=AnkaPanAPI.Utils,i=0,n=0;n<t.length;n++){var o=t[n].getPoints(),a=o[0],s=o[1],r=o[2],l=isNaN(a.alt)||void 0===a.alt||null==a.alt?0:a.alt,h=isNaN(s.alt)||void 0===s.alt||null==s.alt?0:s.alt,c=isNaN(r.alt)||void 0===r.alt||null==r.alt?0:r.alt,u=e.haversine(a.lat,s.lat,a.lon,s.lon),p=Math.sqrt(u*u+Math.pow(l-h,2)),f=e.haversine(s.lat,r.lat,s.lon,r.lon),d=Math.sqrt(f*f+Math.pow(h-c,2)),y=e.haversine(r.lat,a.lat,r.lon,a.lon),m=Math.sqrt(y*y+Math.pow(c-l,2));i+=e.heron(p,d,m)}var g=Math.round(1e3*i)/1e3;this.areaSize=g+"m²",this.setLabel()}},getArea:function(){for(var t=AnkaPanAPI.Utils,e=0,i=0;i<this.triangles.length;i++){var n=this.triangles[i].getPoints(),o=n[0],a=n[1],s=n[2],r=isNaN(o.alt)||void 0===o.alt||null==o.alt?0:o.alt,l=isNaN(a.alt)||void 0===a.alt||null==a.alt?0:a.alt,h=isNaN(s.alt)||void 0===s.alt||null==s.alt?0:s.alt,c=t.haversine(o.lat,a.lat,o.lon,a.lon),u=Math.sqrt(c*c+Math.pow(r-l,2)),p=t.haversine(a.lat,s.lat,a.lon,s.lon),f=Math.sqrt(p*p+Math.pow(l-h,2)),d=t.haversine(s.lat,o.lat,s.lon,o.lon),y=Math.sqrt(d*d+Math.pow(h-r,2));e+=t.heron(u,f,y)}return e},setPoints:function(t){var e;for(this.points.length=0,e=0;e<t.length;e++)this.points.push(t[e])},setLabel:function(){if(!this.openGeom){var t=this.getCentroid(),e=this.panogl.getMainCamera();this.labelHook.position.set(t.x,t.y,t.z),this.add(this.labelHook),this._commonGeom.attributes._areaSize=this.areaSize,this.softText&&this.softText.addObject3D(this.labelHook,e,this.getLabelText())}},getCentroid:function(){for(var t=this.points,e=5e8,i=5e8,n=5e8,o=-5e8,a=-5e8,s=-5e8,r=0;r<t.length;r++){var l=t[r],h=this.scalable.calculatePointPositionFromLonLatAlt(l.lon,l.lat,l.alt);h.x<e&&(e=h.x),h.x>o&&(o=h.x),h.z<n&&(n=h.z),h.z>s&&(s=h.z),h.y<i&&(i=h.y),h.y>a&&(a=h.y)}return{x:e+(o-e)/2,y:i+(a-i)/2,z:n+(s-n)/2}},onClick:function(t){t.currentTarget=this,this.throwEvent(t)},addPoint:function(t,e,i){this.points.push({lon:t,lat:e,alt:i})},onSelect:function(){this.line.material.color=new THREE.Color(0,.5,1),this.fill.material.color=new THREE.Color(.1,1,1),this.fill.material.opacity=1},onDeSelect:function(){this.__layer?this.updateStyle():(this.line.material.color=new THREE.Color(this._lineColor),this.fill.material.color=new THREE.Color(this._fillColor),this.fill.material.opacity=this.opacity)},updateStyle:function(){if(this.__layer){var t=this.__layer.getStyle(this);this.fill.material.color=new THREE.Color(t.fillColor),this.fill.material.opacity=t.fillOpacity*this.getOpacity(),this.line.material.color=new THREE.Color(t.lineColor),this.line.material.opacity=t.lineOpacity*this.getOpacity()}},removeAnchoPoints:function(){var t=this.vertexPoints;t&&(this.remove(t),t.geometry.dispose())},update:function(){var t=this.getPositionedPoints(),e=this.getPositionedHolePoints(),i=this.getBounds(t),n=this.updateLineVertices(t,i,e);this.position.set(0,0,0);var o=t.reduce((function(t,e){var i=e.x,n=e.y,o=e.z;return t.push(i,n,o),t}),[]);if(this.removeAnchoPoints(),o.length>0){var a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.BufferAttribute(new Float32Array(o),3));var s=new THREE.Points(a,O);this.add(s),this.vertexPoints=s}if(!(n.length<3)){var r,l,h,c,u=n[0],p=n[1],f=n[2],d=AnkaPanAPI.Utils.GetNormal(u,p,f),y=new THREE.Vector3(d.x,d.y,d.z);if(y.normalize(),Math.abs(y.z)>Math.abs(y.y)&&Math.abs(y.z)>Math.abs(y.x)){if(h=!0,r=this.getNonReapetedPoints(n,"x","y"),this.holes&&this.holes.length>0)for(l=[],c=0;c<e.length;c++){var m=e[c],g=this.getNonReapetedPoints(m,"x","z");if(g)for(var v=0;v<g.length;v++)g[v]._x=g[v].x,g[v]._y=g[v].y,g[v]._z=g[v].z,g[v].y=g[v]._z,g[v].z=g[v]._y;l.push(g)}}else{if(h=!1,r=this.getNonReapetedPoints(n,"x","z"),this.holes&&this.holes.length>0)for(l=[],c=0;c<e.length;c++){var b=this.getNonReapetedPoints(e[c],"x","y");l.push(b)}for(c=0;c<r.length;c++)r[c]._x=r[c].x,r[c]._y=r[c].y,r[c]._z=r[c].z,r[c].y=r[c]._z,r[c].z=r[c]._y}if(r.length>2){var _,E=new poly2tri.SweepContext(r);if(l)for(c=0;c<l.length;c++)E.addHole(l[c]);try{_=E.triangulate()}catch(t){return this.canDraw=!1,void console.log(t)}this.canDraw=!0;var T=_.getTriangles();this.updateFillVertices(T,i,h)}this.calculateArea(this.triangles),this.setLabel()}},getNonReapetedPoints:function(t,e,i){for(var n={},o=[],a=0;a<t.length;a++){var s=t[a][e]+"_"+t[a][i];n[s]||(n[s]=1,o.push(t[a]))}return o},getBounds:function(t){for(var e=Number.MIN_SAFE_INTEGER,i=e,n=e,o=e,a=Number.MAX_SAFE_INTEGER,s=a,r=a,l=a,h=0;h<t.length;h++)t[h].x<s&&(s=t[h].x),t[h].y<r&&(r=t[h].y),t[h].z<l&&(l=t[h].z),t[h].x>i&&(i=t[h].x),t[h].y>n&&(n=t[h].y),t[h].z>o&&(o=t[h].z);return{maxX:i,maxY:n,maxZ:o,minX:s,minY:r,minZ:l,halfX:.5*(i-s),halfY:.5*(n-r),halfZ:.5*(o-l)}},updateFillVertices:function(t,e,i){var n=this.fill.geometry,o=n.attributes.position.array,a=n.index.array;this.triangles=t;for(var s=0,r=0,l=0,h=0;h<t.length;h++){var c=t[h];c=c.getPoints();for(var u=0;u<c.length;u++){var p=c[u];i?(o[s++]=p.x,o[s++]=p.z,o[s++]=p.y):(o[s++]=p.x,o[s++]=p.y,o[s++]=p.z),l=3*(h+1)-(u+1),a[r++]=l}}n.setDrawRange(0,s/3),n.attributes.position.needsUpdate=!0,n.index.needsUpdate=!0},updateLineVertices:function(t,e,i){var n=t.length,o=this.line.geometry,a=o.attributes.position.array;if(n!==a.length/3){this.line.geometry.dispose(),this.line.parent&&this.line.parent.remove(this.line),o=new THREE.BufferGeometry;var s=new Float32Array(3*n);o.addAttribute("position",new THREE.BufferAttribute(s,3)),a=o.attributes.position.array,this.line=new THREE.Line(o,this.material),this.line.frustumCulled=!1,this.add(this.line)}for(var r=[],l=0,h=0;h<t.length;h++){var c=t[h];a[l++]=c.x,a[l++]=c.y,a[l++]=c.z,r.push({x:c.x,y:c.z,z:c.y,lon:c.lon,lat:c.lat,alt:c.alt})}return o.setDrawRange(0,t.length),o.attributes.position.needsUpdate=!0,r},getPositionedPoints:function(){for(var t,e,i=[],n=this.points,o=0;o<n.length;o++)t=n[o],(e=this.scalable.calculatePointPositionFromLonLatAlt(t.lon,t.lat,t.alt)).lat=t.lat,e.lon=t.lon,e.alt=t.alt,i.push(e);return this.dynamicPoint&&(t=this.dynamicPoint,(e=this.scalable.calculatePointPositionFromLonLatAlt(t.lon,t.lat,t.alt)).lat=t.lat,e.lon=t.lon,e.alt=t.alt,i.push(e)),i},getPositionedHolePoints:function(){if(this.holes&&0!==this.holes.length){for(var t=[],e=0;e<this.holes.length;e++){for(var i=[],n=this.holes[e],o=0;o<n.length;o++){var a=n[o],s=this.scalable.calculatePointPositionFromLonLatAlt(a.lon,a.lat,a.alt);s.lat=a.lat,s.lon=a.lon,s.alt=a.alt,i.push(s)}t.push(i)}return t}},disableAll:function(){this.parent&&this.parent.remove(this),this.enabled=!1},destroy:function(){this.disableAll();var t=this.line;t&&(t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose());var e=this.fill;e&&(e.setClickable(!1),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()),this.labelHook&&(this.softText&&this.softText.removeObject3D(this.labelHook),this.softText=null,this.labelHook=null)}});var V,U,W,q=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&N(t,e)}(a,t);var e,i,n,o=F(a);function a(t,e){var i;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,a),(i=o.call(this,void 0,e)).groundLabel=null,i._lines=[],i._meshLines=[],i._clickMeshes=[],i.canDraw=!0,i._scalable=t,i.softText=t.softText,i.labelHook=new THREE.Object3D,i.material=new THREE.LineMaterial({color:16711935,linewidth:5,dashed:!0,depthTest:!0,transparent:!0,depthWrite:!1}),i._vertexPointMaterial=new THREE.PointsMaterial({color:16777215,size:5,opacity:.1,transparent:!0,depthWrite:!1,depthTest:!1,sizeAttenuation:!1}),t.getBasePano().addResizeMaterial(i.material),i}return e=a,(i=[{key:"type",get:function(){return"MultiLine"}},{key:"enable",value:function(t){this.enabled||(this.openGeom=!0,this.panogl=t,this.canDraw=!0)}},{key:"stopDraw",value:function(){this.openGeom=!1,this.dynamicPoint=null,this.setLabel()}},{key:"setLabel",value:function(){var t=this.__layer;if(!t||t.getLabelVisibility()){if(!this.openGeom){for(var e=0,i=0;i<this._lines.length;i++){for(var n=this._lines[i],o=0,a=0;a<n.length-1;a++){var s=n[a],r=n[a+1],l=AnkaPanAPI.Utils.haversine(s.lat,r.lat,s.lon,r.lon),h=isNaN(s.alt)||void 0===s.alt||null==s.alt?0:s.alt,c=isNaN(r.alt)||void 0===r.alt||null==r.alt?0:r.alt;if(h!==c){var u=h-c;l=Math.sqrt(u*u+l*l)}o+=l}e+=o}var p=this.getCentroid(),f=this.panogl.getMainCamera();if(this.labelHook.position.set(p.x,p.y,p.z),this.add(this.labelHook),this._commonGeom.attributes._length=Math.round(100*e)/100+"m",t.isLabelOnLine)this.createGroundLabel(this.getLabelText());else{var d=this.getLabelText();this.softText&&this.softText.addObject3D(this.labelHook,f,d)}}}else this.labelHook&&this.softText&&this.softText.removeObject3D(this.labelHook)}},{key:"createGroundLabel",value:function(t){for(var e=[],i=0;i<this._lines.length;i++)for(var n=0;n<this._lines[i].length;n++){var o=this._lines[i][n],a=this._scalable.calculatePointPositionFromLonLatAlt(o.lon,o.lat,o.alt);e.push(new THREE.Vector3(a.x,a.y,a.z))}var s=AnkaPanAPI.Utils.createTextTextureForGround(t).texture;s.generateMipmaps=!1,s.minFilter=THREE.LinearFilter,s.magFilter=THREE.LinearFilter,s.wrapS=s.wrapT=THREE.RepeatWrapping;var r=new THREE.MeshBasicMaterial({map:s,transparent:!0,alphaTest:0,depthWrite:!1,depthTest:!1}),l=new S(e);this.groundLabel=new THREE.Mesh(l,r),this.add(this.groundLabel)}},{key:"getCentroid",value:function(){for(var t=[],e=0;e<this._lines.length;e++){var i=this._lines[e];t=t.concat(i)}for(var n=5e8,o=5e8,a=5e8,s=-5e8,r=-5e8,l=-5e8,h=0;h<t.length;h++){var c=t[h],u=this._scalable.calculatePointPositionFromLonLatAlt(c.lon,c.lat,c.alt);u.x<n&&(n=u.x),u.x>s&&(s=u.x),u.z<a&&(a=u.z),u.z>l&&(l=u.z),u.y<o&&(o=u.y),u.y>r&&(r=u.y)}return{x:n+(s-n)/2,y:o+(r-o)/2,z:a+(l-a)/2}}},{key:"onClick",value:function(t){t.currentTarget=this,this.throwEvent(t)}},{key:"setData",value:function(t,e){this.attributes=e;for(var i=[],n=0;n<t.length;n++){for(var o=t[n],a=[],s=0;s<o.length;s++)a.push(o[s]);i.push(a)}this._lines=i}},{key:"updateStyle",value:function(){if(this.__layer){var t=this.__layer.getStyle(this);this.material.color=new THREE.Color(t.lineColor);var e=t.lineOpacity*this.getOpacity();isNaN(e)&&(e=1),this._vertexPointMaterial.opacity=e,this.material.opacity=e,this.material.linewidth=t.lineWidth}}},{key:"onSelect",value:function(){this.material.color=new THREE.Color(0,1,1)}},{key:"onDeSelect",value:function(){this.updateStyle()}},{key:"destroyMeshes",value:function(){for(var t=this._meshLines,e=0;e<t.length;e++){var i=t[e];i.geometry.dispose(),this.remove(i)}t.length=0}},{key:"createIntersecyLines",value:function(){this.destroyClickMeshes();for(var t=this._vertices,e=0;e<t.length;e++){var i=t[e],n=new THREE.BufferGeometry,o=new Float32Array(i);n.addAttribute("position",new THREE.BufferAttribute(o,3));var a=new D(n,new THREE.LineBasicMaterial({color:new THREE.Color(1,1,0),linewidth:1,depthTest:!0,opacity:0,transparent:!0,depthWrite:!1}));a.name="SMultiLine_çizim",this.add(a);var s=this.panogl.getMainCamera();a.setClickable(!0,this.panogl,null,s),a.addEvent(T.CLICK,this,this.onClick),a.addEvent(T.MOUSE_DOWN,this,this.onDown),this._clickMeshes.push(a)}}},{key:"update",value:function(){this.vertexPoints&&(this.remove(this.vertexPoints),this.vertexPoints.geometry.dispose()),this.position.set(0,0,0);for(var t=0;t<this._meshLines.length;t++){var e=this._meshLines[t];e.geometry.dispose(),this.remove(e)}this._vertices=[];for(var i=this._lines,n=0;n<i.length;n++){for(var o=i[n],a=[],s=0;s<o.length;s++){var r=o[s],l=this._scalable.calculatePointPositionFromLonLatAlt(r.lon,r.lat,r.alt);a.push(l.x,l.y,l.z)}this._vertices.push(a);var h=new THREE.LineGeometry,c=new THREE.Line2(h,this.material);c.name="SMultiLine_"+this.uid,c.frustumCulled=!1,c.geometry.setPositions(a),c.computeLineDistances(),this.add(c),this._meshLines.push(c),this.material.resolution.set(window.innerWidth,window.innerHeight)}var u=this._vertices.reduce((function(t,e){return e.concat(t)}),[]);if(u.length>0){var p=new THREE.BufferGeometry;p.addAttribute("position",new THREE.BufferAttribute(new Float32Array(u),3));var f=new THREE.Points(p,this._vertexPointMaterial);this.vertexPoints=f,this.add(f)}this.createIntersecyLines(),this.setLabel()}},{key:"disableAll",value:function(){this.parent&&this.parent.remove(this),this.enabled=!1}},{key:"destroyClickMeshes",value:function(){for(var t=this._clickMeshes,e=0;e<t.length;e++){var i=t[e];i.geometry.dispose(),i.material.dispose(),i.setClickable(!1),this.remove(i)}}},{key:"destroy",value:function(){this.disableAll(),this.destroyClickMeshes();for(var t=this._meshLines,e=0;e<t.length;e++){var i=t[e];i.geometry.dispose(),i.material.dispose(),this.remove(i)}var n=this.vertexPoints;n&&(n.geometry.dispose(),n.material.dispose(),this.remove(this.vertexPoints)),this._scalable.getBasePano().removeResizeMaterial(this.material),this.material.dispose(),this.groundLabel&&(this.groundLabel.geometry.dispose(),this.groundLabel.material.map.dispose(),this.groundLabel.material.dispose()),this.material&&this.material.dispose(),this.softText&&this.labelHook&&this.softText.removeObject3D(this.labelHook)}}])&&j(e.prototype,i),n&&j(e,n),Object.defineProperty(e,"prototype",{writable:!1}),a}(T);function K(t,e){T.apply(this,arguments),this.polygons=[],this.fillMeshes=[],this.lineMeshes=[],this.triangles=[],this.type="Polygon",this._lineColor=255,this.canDraw=!0,this.scalable=t,this.softText=t.softText,this.opacity=.5,this.labelHook=new THREE.Object3D,this.lineMaterial=new THREE.LineBasicMaterial({color:this._lineColor,linewidth:1,depthTest:!0,transparent:!0,side:THREE.DoubleSide}),this._fillColor=16776960,this.fillMat=new THREE.MeshBasicMaterial({color:this._fillColor,depthTest:!0,transparent:!0,opacity:this.opacity,side:THREE.DoubleSide})}function Y(t){return(Y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function X(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function Z(t,e){return(Z=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function J(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,n=tt(t);if(e){var o=tt(this).constructor;i=Reflect.construct(n,arguments,o)}else i=n.apply(this,arguments);return Q(this,i)}}function Q(t,e){if(e&&("object"===Y(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function tt(t){return(tt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}q.isMultiGeom=!0,K.isMultiGeom=!0,K.prototype=Object.assign(Object.create(T.prototype),{constructor:K,reset:function(){this.lookAt(new THREE.Vector3(0,this.position.y,0))},enable:function(t,e){this.enabled||(this.openGeom=!0,this.panogl=t)},stopDraw:function(){this.openGeom=!1;for(var t=0;t<this.polygons.length;t++){var e=this.polygons[t],i=e[0],n=e[e.length-1];n.lat===i.lat&&n.lon===i.lon&&n.alt===i.alt||e.push(i),this.dynamicPoint=null,this.update()}},setData:function(t,e,i){this.attributes=e,this.polygons.length=0;for(var n=0;n<t.length;n++){for(var o=[],a=t[n],s=0;s<a.length;s++)o.push(a[s]);this.polygons.push(o)}},calculateArea:function(t){if(t){for(var e=AnkaPanAPI.Utils,i=0,n=0;n<t.length;n++){var o=t[n].getPoints(),a=o[0],s=o[1],r=o[2],l=isNaN(a.alt)||void 0===a.alt||null==a.alt?0:a.alt,h=isNaN(s.alt)||void 0===s.alt||null==s.alt?0:s.alt,c=isNaN(r.alt)||void 0===r.alt||null==r.alt?0:r.alt,u=e.haversine(a.lat,s.lat,a.lon,s.lon),p=Math.sqrt(u*u+Math.pow(l-h,2)),f=e.haversine(s.lat,r.lat,s.lon,r.lon),d=Math.sqrt(f*f+Math.pow(h-c,2)),y=e.haversine(r.lat,a.lat,r.lon,a.lon),m=Math.sqrt(y*y+Math.pow(c-l,2));i+=e.heron(p,d,m)}return i}},setLabel:function(){if(!this.openGeom&&this.softText){var t=this.getCentroid(),e=this.panogl.getMainCamera();this.labelHook.position.set(t.x,t.y,t.z),this.add(this.labelHook),this._commonGeom.attributes._areaSize=this.areaSize,this.softText.addObject3D(this.labelHook,e,this.getLabelText())}},getCentroid:function(){for(var t=[],e=0;e<this.polygons.length;e++){var i=this.polygons[e];t=t.concat(i)}for(var n=5e8,o=5e8,a=5e8,s=-5e8,r=-5e8,l=-5e8,h=0;h<t.length;h++){var c=t[h],u=this.scalable.calculatePointPositionFromLonLatAlt(c.lon,c.lat,c.alt);u.x<n&&(n=u.x),u.x>s&&(s=u.x),u.z<a&&(a=u.z),u.z>l&&(l=u.z),u.y<o&&(o=u.y),u.y>r&&(r=u.y)}return{x:n+(s-n)/2,y:o+(r-o)/2,z:a+(l-a)/2}},onClick:function(t){t.currentTarget=this,this.throwEvent(t)},addPoint:function(t,e,i){console.warn("addpoint deprecated")},onSelect:function(){this.lineMaterial.color=new THREE.Color(0,.5,1),this.fillMat.color=new THREE.Color(.1,1,1),this.fillMat.opacity=1},onDeSelect:function(){this.__layer?this.updateStyle():(this.lineMaterial.color=new THREE.Color(this._lineColor),this.fillMat.color=new THREE.Color(this._fillColor),this.fillMat.opacity=this.opacity)},cleanMeshes:function(){for(var t=0;t<this.lineMeshes.length;t++)this.remove(this.lineMeshes[t]),this.lineMeshes[t].geometry.dispose();for(var e=0;e<this.fillMeshes.length;e++)this.fillMeshes[e].setClickable(!1),this.remove(this.fillMeshes[e]),this.fillMeshes[e].geometry.dispose();this.fillMeshes.length=0,this.lineMeshes.length=0,this.triangles.length=0},updateStyle:function(){if(this.__layer){var t=this.__layer.getStyle(this);this.fillMat.color=new THREE.Color(t.fillColor),this.fillMat.opacity=t.fillOpacity*this.getOpacity(),this.lineMaterial.color=new THREE.Color(t.lineColor),this.lineMaterial.opacity=t.lineOpacity*this.getOpacity()}},update:function(){this.cleanMeshes();for(var t=0;t<this.polygons.length;t++)this.updateGeomAt(t);for(var e=0,i=0;i<this.triangles.length;i++)e+=this.calculateArea(this.triangles[i]);this.areaSize=Math.round(100*e)/100+"m²",this.setLabel(),this.position.set(0,0,0)},updateGeomAt:function(t){var e=this.getPositionedPoints(t),i=this.getPositionedHolePoints(),n=this.getBounds(e),o=this.updateLineVerticesAt(t,e,n,i);if(!(o.length<3)){var a,s,r,l=o[0],h=o[1],c=o[2],u=AnkaPanAPI.Utils.GetNormal(l,h,c),p=new THREE.Vector3(u.x,u.y,u.z);if(p.normalize(),Math.abs(p.z)>Math.abs(p.y)&&Math.abs(p.z)>Math.abs(p.x)){if(r=!0,a=this.getNonReapetedPoints(o,"x","y"),this.holes&&this.holes.length>0){s=[];for(var f=0;f<i.length;f++){var d=i[f],y=this.getNonReapetedPoints(d,"x","z");if(y)for(var m=0;m<y.length;m++)y[m]._x=y[m].x,y[m]._y=y[m].y,y[m]._z=y[m].z,y[m].y=y[m]._z,y[m].z=y[m]._y;s.push(y)}}}else{if(r=!1,a=this.getNonReapetedPoints(o,"x","z"),this.holes&&this.holes.length>0){s=[];for(var g=0;g<i.length;g++){var v=this.getNonReapetedPoints(i[g],"x","y");s.push(v)}}for(var b=0;b<a.length;b++)a[b]._x=a[b].x,a[b]._y=a[b].y,a[b]._z=a[b].z,a[b].y=a[b]._z,a[b].z=a[b]._y}if(a.length>2){var _,E=new poly2tri.SweepContext(a);if(s)for(var T=0;T<s.length;T++)E.addHole(s[T]);window.swctx=E;try{_=E.triangulate()}catch(t){return this.canDraw=!1,void console.log(t)}this.canDraw=!0;var w=_.getTriangles();this.updateFillVerticesAt(t,w,n,r)}else console.log("not enough points")}},getNonReapetedPoints:function(t,e,i){for(var n={},o=[],a=0;a<t.length;a++){var s=t[a][e]+"_"+t[a][i];n[s]||(n[s]=1,o.push(t[a]))}return o},getBounds:function(t){for(var e=Number.MIN_SAFE_INTEGER,i=e,n=e,o=e,a=Number.MAX_SAFE_INTEGER,s=a,r=a,l=a,h=0;h<t.length;h++)t[h].x<s&&(s=t[h].x),t[h].y<r&&(r=t[h].y),t[h].z<l&&(l=t[h].z),t[h].x>i&&(i=t[h].x),t[h].y>n&&(n=t[h].y),t[h].z>o&&(o=t[h].z);return{maxX:i,maxY:n,maxZ:o,minX:s,minY:r,minZ:l,halfX:.5*(i-s),halfY:.5*(n-r),halfZ:.5*(o-l)}},updateFillVerticesAt:function(t,e,i,n){var o=new Float32Array(600),s=new Float32Array(600),r=new Uint16Array(200),l=new THREE.BufferGeometry;l.addAttribute("position",new THREE.BufferAttribute(o,3)),l.addAttribute("nomal",new THREE.BufferAttribute(s,3)),l.setIndex(new THREE.BufferAttribute(r,1));var h=new a(l,this.fillMat);h.frustumCulled=!1,l.setDrawRange(0,3),this.add(h),h.setClickable(!0,this.panogl,null,this.panogl.getMainCamera()),h.addEvent(T.CLICK,this,this.onClick),h.addEvent(T.MOUSE_DOWN,this,this.onDown),this.fillMeshes.push(h);var c=l,u=c.attributes.position.array;this.triangles.push(e);for(var p=0,f=0,d=0,y=0;y<e.length;y++){var m=e[y];m=m.getPoints();for(var g=0;g<m.length;g++){var v=m[g];n?(u[p++]=v.x,u[p++]=v.z,u[p++]=v.y):(u[p++]=v.x,u[p++]=v.y,u[p++]=v.z),d=3*(y+1)-(g+1),r[f++]=d}}c.setDrawRange(0,p/3),c.attributes.position.needsUpdate=!0,c.index.needsUpdate=!0},updateLineVerticesAt:function(t,e,i,n){var o=e.length,a=new THREE.BufferGeometry,s=new Float32Array(3*o);a.addAttribute("position",new THREE.BufferAttribute(s,3));var r=new THREE.Line(a,this.lineMaterial);r.frustumCulled=!1,this.lineMeshes.push(r);for(var l=[],h=(a=r.geometry).attributes.position.array,c=0,u=0;u<e.length;u++){var p=e[u];h[c++]=p.x,h[c++]=p.y,h[c++]=p.z,l.push({x:p.x,y:p.z,z:p.y,lon:p.lon,lat:p.lat,alt:p.alt})}return a.setDrawRange(0,e.length),a.attributes.position.needsUpdate=!0,a.computeBoundingBox(),this.add(r),l},getPositionedPoints:function(t){for(var e=this.polygons[t],i=[],n=0;n<e.length;n++){var o=e[n],a=this.scalable.calculatePointPositionFromLonLatAlt(o.lon,o.lat,o.alt);a.lat=o.lat,a.lon=o.lon,a.alt=o.alt,i.push(a)}return i},getPositionedHolePoints:function(){if(this.holes&&0!==this.holes.length){for(var t=[],e=0;e<this.holes.length;e++){for(var i=[],n=this.holes[e],o=0;o<n.length;o++){var a=n[o],s=this.scalable.calculatePointPositionFromLonLatAlt(a.lon,a.lat,a.alt);s.lat=a.lat,s.lon=a.lon,s.alt=a.alt,i.push(s)}t.push(i)}return t}},disableAll:function(){this.parent&&this.parent.remove(this),this.enabled=!1},destroy:function(){this.disableAll(),this.cleanMeshes(),this.labelHook&&(this.softText&&this.softText.removeObject3D(this.labelHook),this.softText=null)}});var et=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Z(t,e)}(s,t);var e,i,n,o=J(s);function s(t,e){var i;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s),(i=o.call(this,t,e)).type="MultiPoint",i.softText=t.softText,!s.__hookTexture){var n=r.getInstance().GetAssetNoCache("img/scalable/hook.jpg");n.generateMipmaps=!1,n.minFilter=y,s.__hookTexture=n}if(!s.__hookGeom){var a=new c,l=new h;a.vertices.push(l),s.__hookGeom=a}var p=new u({size:8,sizeAttenuation:!1,map:s.__hookTexture,depthTest:!0,depthWrite:!0,transparent:!0});return i.hookMaterial=p,i.iconGeom=s.__iconGeom,i.hookGeom=s.__hookGeom,i.scalable=t,i}return e=s,(i=[{key:"reset",value:function(){this.update(),this.lookAt(new h(0,this.position.y,0))}},{key:"onClick",value:function(t){t.currentTarget=this,this.throwEvent(t)}},{key:"onSelect",value:function(){this.icon.material.color=new m(65535)}},{key:"setPoints",value:function(t){if(1===t.length){var e=t[0];this.setLocation(e.lon,e.lat,e.alt),this.reset()}else console.warn("SMultiPoint doesn't multi point input!")}},{key:"stopDraw",value:function(){this.update()}},{key:"setDynamicPoint",value:function(){}},{key:"setData",value:function(t,e){if(this.attributes=e,1===t.length){var i=t[0];this.setLocation(i.lon,i.lat,i.alt),this.visible=!0}else console.warn("SMultiPoint doesn't multi point input!")}},{key:"onDeSelect",value:function(){this.icon.material.color=new m(16777215)}},{key:"enable",value:function(t,e){this.panogl=t,this.enabled||this.icon||(this.hookMesh=new f(this.hookGeom,this.hookMaterial),this.add(this.hookMesh))}},{key:"updateStyle",value:function(){if(this.__layer){this.icon&&(this.icon.material.dispose(),this.icon.setClickable(!1),this.icon.parent&&this.icon.parent.remove(this.icon)),this.hookMesh&&(this.hookMesh.material.opacity=this.getOpacity());var t=this.__layer.getStyle(this);t.texture||function(t){if(!V){(V=document.createElement("canvas")).width=16,V.height=16;var e=V.getContext("2d");e.fillStyle="#ffffff",e.fillRect(0,0,16,16),V.style.top="0px"}U||(U=new d(V)),W||(W=new p(16,16,1,1)),t.texture=U,t.xoffset=0,t.yoffset=0,t.geometry=W}(t);var e=t.texture;if(e){e.needsUpdate=!0;var i=t.geometry,n=new THREE.MeshBasicMaterial({map:e,color:16777215,transparent:!0,alphaTest:.2});this.icon=new a(i,n),this.icon.material.opacity=this.getOpacity(),this.add(this.icon);var o=this.panogl,s=o.getMainCamera();this.icon.setClickable(!0,o,null,s),this.icon.position.set(t.xoffset,t.yoffset,-1),this.icon.addEvent(T.CLICK,this,this.onClick),this.icon.addEvent(T.MOUSE_DOWN,this,this.onDown)}}}},{key:"update",value:function(){null!=this.lon&&null!=this.lat&&(this.setLocation(this.lon,this.lat,this.alt),this.lookAt(new h(0,this.position.y,0)),this.setLabel())}},{key:"setLabel",value:function(){var t=this.softText;if(!this.__layer||this.__layer.getLabelVisibility()){if(!this.labelHook){this.labelHook=new THREE.Object3D,this.add(this.labelHook);var e=this.panogl.getMainCamera(),i=isNaN(this.alt)||!this.alt?"0":this.alt.toFixed(6),n=this._commonGeom;n.attributes._lon=this.lon,n.attributes._lat=this.lat,n.attributes._alt=i;var o=this.getLabelText();t&&t.addObject3D(this.labelHook,e,o)}}else this.labelHook&&(t&&t.removeObject3D(this.labelHook),this.remove(this.labelHook),this.labelHook=null)}},{key:"setLocation",value:function(t,e,i){this.lat=e,this.lon=t,this.alt=i;var n=this.scalable.calculatePointPositionFromLonLatAlt(t,e,i),o=isNaN(this.alt)||!this.alt?"0":this.alt.toFixed(6);this.attributes.___location="lon:"+this.lon.toFixed(6)+" lat:"+this.lat.toFixed(6)+" alt:"+this.alt,this.points[0]={lon:t,lat:e,alt:o},this.position.set(n.x,n.y,n.z)}},{key:"disableAll",value:function(){this.icon&&this.icon.setClickable(!1),this.parent&&this.parent.remove(this),this.enabled=!1}},{key:"destroy",value:function(){if(this.disableAll(),this.icon&&(this.icon.geometry&&this.icon.geometry.dispose(),this.icon.material&&this.icon.material.dispose()),this.hookMesh&&this.hookMesh.material&&this.hookMesh.material.dispose(),this.labelHook){var t=this.softText;t&&t.removeObject3D(this.labelHook),this.softText=null,this.labelHook=null}}}])&&X(e.prototype,i),n&&X(e,n),Object.defineProperty(e,"prototype",{writable:!1}),s}(T);function it(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==i)return;var n,o,a=[],s=!0,r=!1;try{for(i=i.call(t);!(s=(n=i.next()).done)&&(a.push(n.value),!e||a.length!==e);s=!0);}catch(t){r=!0,o=t}finally{try{s||null==i.return||i.return()}finally{if(r)throw o}}return a}(t,e)||nt(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function nt(t,e){if(t){if("string"==typeof t)return ot(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?ot(t,e):void 0}}function ot(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}et.isMultiGeom=!0,st.CHANGE="onChange",st.STATUS={COMPLETED:1,DRAWING:2,BAD_COMPLETED:3};var at={pointType:/^(POINT ZM|POINT Z|POINT)/i,lineType:/^(linestring ZM|LINESTRING Z|LINESTRING)/i,polygonType:/^(POLYGON ZM|POLYGON Z|POLYGON)/i,multi:/^(multi)/i,multiLineString:/^(MultiLineString ZM|MultiLineString Z|MultiLineString)/i,multiPoint:/^(multiPoint ZM|multiPoint Z|multiPoint)/i,multiPolygon:/^(MultiPolygon ZM|MultiPolygon Z|MultiPolygon)/i};function st(t,e,i){AnkaPanAPI.Base.apply(this,[]),this.layer=null,this.isDrawnData=!1,this.points=e,this.holes=null,this.referanceCounter=0,this.attributes=null==i?{}:i,this.setSampleClass(t),this.isMultiGeom=t.isMultiGeom,this.__isSelected=!1,st.___uicounter++,this.userData={};var n=st.___uicounter,o={get:function(){return n},set:function(t){throw new Error("Cannot be set any value")}};Object.defineProperty(this,"uniqueID",o),Object.defineProperty(this.attributes,"__uniqueID",o)}function rt(t){THREE.BufferGeometry.call(this),this.points=t,this.createBufferPlaneGeometry()}function lt(t){return(lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function ht(t,e,i,n){this.isSketchLayer=!1,this.__visible=!0,this.__labelTextSample="",this.__layerOpacity=1,this.__meshStorage={},this.name=t,this.__keyID=e,this.__layerID="id_"+t,this._isLabelVisible=!0,ht.__instances[this.__layerID]||(ht.__instances[this.__layerID]=[],ht.__instancesValues[this.__layerID]={},ht.__instancesValues[this.__layerID].currentState=ht.STATES.NORMAL,ht.__instancesValues[this.__layerID].commonGeometries=[],ht.__instancesValues[this.__layerID].drawingGeoms=[]),this.setState(ht.STATES.NORMAL),ht.__instances[this.__layerID].push(this),this.__geomType=i,this._geometries=[],AnkaPanAPI.Base.apply(this,[]),this.__objectContainer=new THREE.Object3D,this.__objectContainer.mouseDisabled=!0,this.releaseAnchor=this.releaseAnchor.bind(this),this.onMouseUpOnGeom=this.onMouseUpOnGeom.bind(this),this.__style={lineWidth:5,lineColor:16711680,fillColor:16776960,fillOpacity:.4,lineOpacity:.6},n&&this.setStyle(n),Object.defineProperty(this,"visible",{set:function(t){this.__visible=t,this.__visible?this.refresh():this.removeAllChildren(),this.scalable.setDirty()},get:function(){return this.__visible}})}function ct(){ht.apply(this,arguments),this.isSketchLayer=!0}st.POLYGON="Polygon",st.LINE="Line",st.POINT="Point",st.HLINE="Hline",st.CLICK="onClick",st.SELECT="onSelect",st.DESELECT="onDeSelect",st.MOVE_EDIT="onMoveEdit",st.MOVE_EDIT_STOP="onMoveEditStop",st.VERTEX_EDIT="onVertexEdit",st.VERTEX_EDIT_STOP="onVertexEditStop",st.___uicounter=12,st.prototype=Object.assign(Object.create(AnkaPanAPI.Base.prototype),{constructor:st,isCompleted:function(){return st.STATUS.COMPLETED===this.currentStatus},isDrawing:function(){return st.STATUS.DRAWING===this.currentStatus},addRC:function(){return++this.referanceCounter},removeRC:function(){return--this.referanceCounter},hasReferance:function(){return this.referanceCounter>0},setPoints:function(t){this.points=t,this.throwEvent({type:st.CHANGE,target:this})},resetPoints:function(){this.points.length=0},setSampleClass:function(t){var e=this.points;if(t===w)this.type=st.POINT;else if(t===G||t===q)this.type=st.LINE;else if(t===k||t===K)if(this.type=st.POLYGON,t===k){var i=e;if(i.length>1){var n=i[0],o=i[i.length-1];o.lat===n.lat&&o.lon===n.lon&&o.lon===n.lon&&i.splice(i.length-1,1)}}else for(var a=0;a<e.length;a++){var s=e[a];if(s.length>1){var r=s[0],l=s[s.length-1];l.lat===r.lat&&l.lon===r.lon&&l.lon===r.lon&&s.splice(s.length-1,1)}}this.sampleClass=t},isMoveEditing:function(){return this._isMoveEditing},editMove:function(){this._isMoveEditing=!0,this.throwEvent({type:st.MOVE_EDIT,target:this})},stopMoveEdit:function(){this._isMoveEditing=!1,this.throwEvent({type:st.MOVE_EDIT_STOP,target:this})},editVertex:function(){this.isVertexEditing()||(this._isVertextEditing=!0,this.throwEvent({type:st.VERTEX_EDIT,target:this}))},stopVertexEdit:function(){this.isVertexEditing()&&(this._isVertextEditing=!1,this.throwEvent({type:st.VERTEX_EDIT_STOP,target:this}))},isVertexEditing:function(){return this._isVertextEditing},setSelection:function(t){console.warn("setSelection is deprecated. Use select or deselect "),this.__isSelected!==t&&(t?(this.__isSelected=t,this.throwEvent({type:st.SELECT,target:this})):(this.__isSelected=t,this.throwEvent({type:st.DESELECT,target:this})))},select:function(){this.__isSelected||(this.__isSelected=!0,this.throwEvent({type:st.SELECT,target:this}))},deselect:function(){this.__isSelected&&(this.__isSelected=!1,this.throwEvent({type:st.DESELECT,target:this}))},isSelected:function(){return this.__isSelected},getKeyValue:function(t){return this.attributes[t]},setAttributes:function(t){this.attributes=t,this.throwEvent({type:st.CHANGE,target:this})},mergeAttributes:function(t){for(var e in t)this.attributes[e]=t[e];this.throwEvent({type:st.CHANGE,target:this})},setAttribute:function(t,e){this.attributes[t]=e,this.throwEvent({type:st.CHANGE,target:this})},addOffset:function(t,e,i,n){if(this.sampleClass.isMultiGeom)for(var o=0;o<this.points.length;o++)for(var a=this.points[o],s=0;s<a.length;s++)a[s].lon+=t,a[s].lat+=e,isNaN(a[s].alt)?a[s].alt=n+i:a[s].alt+=i;else for(var r=0;r<this.points.length;r++){var l=this.points[r];l.lon+=t,l.lat+=e,isNaN(l.alt)?l.alt=n+i:l.alt+=i}this.throwEvent({type:st.CHANGE,target:this})},addPoint:function(t){this.points.push(t),this.throwEvent({type:st.CHANGE,target:this})},removeLastPoint:function(){this.points.length>0&&(this.points.pop(),this.throwEvent({type:st.CHANGE,target:this}))},setDynamicPoint:function(t){this.dynamicPoint=t,this.throwEvent({type:st.CHANGE,target:this,dynamicPoint:this.dynamicPoint})},cloneFrom:function(t){this.points=t.points},setPointAt:function(t,e){t<0||(this.points[t]=e,this.throwEvent({type:st.CHANGE,target:this}))},setStatus:function(t){this.currentStatus=t,this.throwEvent({type:st.CHANGE,target:this})},complete:function(){this.setStatus(st.STATUS.COMPLETED),this.throwEvent({type:st.CHANGE,target:this})},getStatus:function(){return this.currentStatus},getPointLength:function(){return this.points?this.points.length:0},notifyPointChange:function(){this.throwEvent({type:st.CHANGE,target:this})},notifyClick:function(){this.throwEvent({type:st.CLICK,target:this})},toWKT:function(){if(this.sampleClass.isMultiGeom){if(this.sampleClass===K){for(var t="MULTIPOLYGON Z (",e=0;e<this.points.length;e++){for(var i=this.points[e],n="((",o=0;o<i.length;o++){var a=i[o];o>0&&(n+=","),n+=a.lon+" "+a.lat+" "+(isNaN(a.alt)?0:a.alt)}n+="))",e>0&&(n+=","),t+=n}return t+=")"}if(this.sampleClass===et){for(var s="MULTIPOINT Z (",r=0;r<this.points.length;r++){var l=this.points[r],h="(".concat(l.lon," ").concat(l.lat," ").concat(isNaN(l.alt)?0:l.alt,")");s+=h,r!==this.points.length-1&&(h+=",")}return s+=")"}if(this.sampleClass===q){for(var c="MULTILINESTRING Z (",u=0;u<this.points.length;u++){for(var p=this.points[u],f="(",d=0;d<p.length;d++){var y=p[d];d>0&&(f+=","),f+=y.lon+" "+y.lat+" "+(isNaN(y.alt)?0:y.alt)}f+=")",u>0&&(f+=","),c+=f}return c+=")"}console.warn("Type not supported!!!")}else{if(1===this.points.length){var m=this.points[0];return"POINT ("+m.lon+" "+m.lat+" "+m.alt+")"}for(var g=this.points,v="",b=0;b<g.length;b++)b>0&&(v+=","),v+=g[b].lon+" "+g[b].lat+" "+g[b].alt;if(this.type===st.POLYGON)return"Polygon (("+v+"))";if(this.type===st.LINE)return"LINESTRING ("+v+")"}},toGeoJSON:function(){if(0===this.points.length)return null;if(this.type===st.POINT||this.type===st.HLINE){var t={type:"Feature",geometry:{}};for(var e in t.geometry.coordinates=[],t.properties={srid:4236},t.ankaProperties={},this.attributes)"_"!==e[0]?t.properties[e]=this.attributes[e]:t.ankaProperties[e]=this.attributes[e];if(this.sampleClass.isMultiGeom){t.geometry.type="Point";var i=this.points[0];t.geometry.coordinates=[i.lon,i.lat,i.alt]}else{t.geometry.type="MultiPoint";var n,o=function(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=nt(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,r=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return s=t.done,t},e:function(t){r=!0,a=t},f:function(){try{s||null==i.return||i.return()}finally{if(r)throw a}}}}(this.points);try{for(o.s();!(n=o.n()).done;){var a=n.value;t.geometry.coordinates.push([a.lon,a.lat,a.alt])}}catch(t){o.e(t)}finally{o.f()}}return t}if(this.type===st.LINE){var s={type:"Feature",geometry:{}};for(var r in s.geometry.coordinates=[],s.properties={srid:4236},s.ankaProperties={},this.attributes)"_"!==r[0]?s.properties[r]=this.attributes[r]:s.ankaProperties[r]=this.attributes[r];if(this.sampleClass.isMultiGeom){s.geometry.type="MultiLineString";for(var l=0;l<this.points.length;l++){for(var h=this.points[l],c=[],u=0;u<h.length;u++){var p=h[u];c.push([p.lon,p.lat,p.alt])}s.geometry.coordinates.push(c)}}else{s.geometry.type="LineString";for(var f=0;f<this.points.length;f++){var d=this.points[f];s.geometry.coordinates.push([d.lon,d.lat,d.alt])}}return s}if(this.type===st.POLYGON){var y={type:"Feature"},m=this.points[0];for(var g in y.geometry={},y.geometry.coordinates=[],y.properties={},y.ankaProperties={},this.attributes)"_"!==g[0]?y.properties[g]=this.attributes[g]:y.ankaProperties[g]=this.attributes[g];if(this.sampleClass.isMultiGeom){y.geometry.type="MultiPolygon";for(var v=0;v<this.points.length;v++){for(var b=this.points[v],_=[],E=0;E<b.length;E++){var T=b[E];_.push([T.lon,T.lat,T.alt])}var w=_[0],S=_[_.length-1];w[0]===S[0]&&w[1]===S[1]&&w[2]===S[2]||_.push([w[0],w[1],w[2]]),y.geometry.coordinates.push([_])}}else{var P=[];y.geometry.type="Polygon";for(var M=0;M<this.points.length;M++)m=this.points[M],P.push([m.lon,m.lat,m.alt]);var D=P[0],H=P[P.length-1];D[0]===H[0]&&D[1]===H[1]&&D[2]===H[2]||P.push([D[0],D[1],D[2]]),y.geometry.coordinates[0]=P}return y}console.log("Type is not supported")}}),st.fromWKT=function(t,e){var i=function(t){var e;return at.multi.test(t)?at.multiLineString.test(t)?e=q:at.multiPolygon.test(t)?e=K:at.multiPoint.test(t)?e=w:console.warn("Unsupported type"):at.pointType.test(t)?e=w:at.lineType.test(t)?e=G:at.polygonType.test(t)?e=k:console.warn("Unsupported type"),e}(t);if(i){var n=function(t){if(t)if(at.multi.test(t)){var e=/\(|\)/g;if(at.multiLineString.test(t)){for(var i=[],n=t.replace(at.multiLineString,"").trim().split("),("),o=0;o<n.length;o++){for(var a=n[o].trim().replace(e,"").split(","),s=[],r=0;r<a.length;r++){var l=a[r].split(" "),h={lon:parseFloat(l[0]),lat:parseFloat(l[1]),alt:parseFloat(l[2])};s.push(h)}i.push(s)}return{geomCount:i.length,geoms:i}}if(at.multiPolygon.test(t)){for(var c=[],u=t.replace(at.multiPolygon,"").trim().split(")),(("),p=0;p<u.length;p++){for(var f=u[p].replace(e,"").trim().split(","),d=[],y=0;y<f.length;y++){var m=f[y].trim().split(" ");d.push({lon:parseFloat(m[0]),lat:parseFloat(m[1]),alt:parseFloat(m[2])})}c.push(d)}return{geomCount:1,geoms:c}}if(at.multiPoint.test(t)){for(var g=[],v=t.replace(at.multiPoint,"").trim().split(")),(("),b=0;b<v.length;b++){for(var _=v[b].replace(e,"").trim().split(","),E=[],T=0;T<_.length;T++){var w=_[T].trim().split(" ");E.push({lon:parseFloat(w[0]),lat:parseFloat(w[1]),alt:parseFloat(w[2])})}g.push(E)}return{geomCount:1,geoms:g[0]}}}else{var S=/\(|\)/g;if(at.pointType.test(t)){var P=t.replace(at.pointType,"").replace(S,"").trim().split(" ");return{geomCount:1,geoms:[{lon:parseFloat(P[0]),lat:parseFloat(P[1]),alt:parseFloat(P[2])}]}}if(at.lineType.test(t)){for(var M=t.replace(at.lineType,"").replace(S,"").trim().split(","),D=[],H=0;H<M.length;H++){var C=M[H].trim().split(" ");D.push({lon:parseFloat(C[0]),lat:parseFloat(C[1]),alt:parseFloat(C[2])})}return{geomCount:1,geoms:D}}if(at.polygonType.test(t)){var A=t.replace(at.polygonType,""),x=A.split("),(");if(x.length>1){for(var R=x[0].replace(S,"").trim().split(","),L=[],G=0;G<R.length;G++){var O=R[G].trim().split(" ");L.push({lon:parseFloat(O[0]),lat:parseFloat(O[1]),alt:parseFloat(O[2])})}for(var k=[],I=1;I<x.length;I++){for(var j=x[I].replace(S,"").trim().split(","),N=[],F=0;F<j.length;F++){var z=j[F].trim().split(" ");N.push({lon:parseFloat(z[0]),lat:parseFloat(z[1]),alt:parseFloat(z[2])})}k.push(N)}return{geomCount:1,geoms:L,holes:k}}for(var B=A.replace(S,"").trim().split(","),V=[],U=0;U<B.length;U++){var W=B[U].trim().split(" ");V.push({lon:parseFloat(W[0]),lat:parseFloat(W[1]),alt:parseFloat(W[2])})}return{geomCount:1,geoms:V}}}}(t),o=n.geoms,a=n.holes,s=new st(i,o,e);return s.holes=a,s.complete(),s}},st.fromGeoJSON=function(t){var e=t.geometry,i=e.type,n=e.coordinates,o=t.properties,a=t.id;if(void 0===a&&console.warn("feature's uniq ID could not be found!"),at.multi.test(i)){if(at.multiLineString.test(i)){n=n.map((function(t){return t.map((function(t){var e=it(t,3),i=e[0],n=e[1],o=e[2];return-5e3!==o&&0!==o||(o=NaN),{lon:i,lat:n,alt:o}}))}));var s=new st(q,n,Object.assign({__geomKey:a},o));return s.complete(),s}if(at.multiPoint.test(i)){n=n.map((function(t){var e=it(t,3),i=e[0],n=e[1],o=e[2];return-5e3!==o&&0!==o||(o=NaN),{lon:i,lat:n,alt:o}}));var r=new st(et,n,Object.assign({__geomKey:a},o));return r.complete(),r}if(at.multiPolygon.test(i)){var l=[],h=new st(K,n.map((function(t){return t.concat().splice(1).forEach((function(t){var e=t.map((function(t){var e=it(t,3),i=e[0],n=e[1],o=e[2];return-5e3!==o&&0!==o||(o=NaN),{lon:+i,lat:+n,alt:+o}}));0===l.length&&(l=e)})),t[0].map((function(t){var e=it(t,3),i=e[0],n=e[1],o=e[2];return-5e3!==o&&0!==o||(o=NaN),{lon:+i,lat:+n,alt:+o}}))})),Object.assign({__geomKey:a},o));return h.holes=l,h.complete(),h}console.log("Geom type could not be found or recognized",i)}else console.log("Non multi is not supported")},rt.prototype=Object.assign(Object.create(THREE.BufferGeometry.prototype),{constructor:rt,createBufferPlaneGeometry:function(){for(var t=[],e=[],i=[],n=0,o=this.points.length-1,a=Math.ceil(10),s=0;s<o;s++){var r=this.points[s],l=this.points[s+1];t.push(l.x,l.y,l.z),t.push(l.x,r.y+5e3,l.z),t.push(r.x,r.y+5e3,r.z),t.push(r.x,r.y,r.z);var h=r.x-l.x,c=r.y-l.y,u=r.z-l.z,p=Math.sqrt(h*h+c*c+u*u),f=Math.ceil(p/50);e.push(0,0),e.push(a,0),e.push(a,f),e.push(0,f);var d=n,y=n+1,m=n+2,g=n+3;n+=4,i.push(m,y,d),i.push(d,g,m)}this.addAttribute("position",new THREE.Float32BufferAttribute(t,3)),this.addAttribute("uv",new THREE.Float32BufferAttribute(e,2));var v=new Uint16Array(i);return this.setIndex(new THREE.BufferAttribute(v,1)),this.setDrawRange(0,100),this.attributes.position.needsUpdate=!0,this.attributes.uv.needsUpdate=!0,this.computeVertexNormals(),this}}),ht.MOVE_EVENT="onMouseMove",ht.FEATURE_CLICK="onClickFeature",ht.SELECT_FEATURE="onSelectFeature",ht.DESELECT_FEATURE="onDeselectFeature",ht.MOVE_STATUS={STARTED:"STARTED",COMPLETE:"COMPLETE",MOVING:"MOVING"},ht.STATES={NORMAL:"NORMAL",MOVE:"MOVE",VERTEX_EDIT:"VERTEX_EDIT"},ht.__instances={},ht.__instancesValues={},ht.prototype=Object.assign(Object.create(AnkaPanAPI.Base.prototype),{constructor:ht,setLabelVisibility:function(t){if(this._isLabelVisible!==t)for(var e in this._isLabelVisible=t,this.__meshStorage)this.__meshStorage[e].setLabel();this.scalable&&this.scalable.setDirty()},getLabelVisibility:function(){return this._isLabelVisible},setMouseEnable:function(t){this.__objectContainer.mouseDisabled=!t},setStyle:function(t){this.__style=t},add:function(t){console.warn("add method is deprecated")},addGlobal:function(t){if(!(t instanceof st))throw new TypeError("param should be GeomDataHolder");for(var e=t.getKeyValue(this.__keyID),i=ht.__instancesValues[this.__layerID].commonGeometries,n=t,o=0;o<i.length;o++){if(e===i[o].getKeyValue(this.__keyID)){n=i[o];break}}-1===i.indexOf(n)&&i.push(n)},removeFromGlobal:function(t){var e=ht.__instancesValues[this.__layerID].commonGeometries;if(t.removeRC(),!t.hasReferance()){var i=e.indexOf(t);e.splice(i,1)}},addToList:function(t){console.warn("addToList will be deprecated. Use 'addToLocalAndGlobal', 'addGlobal', 'addToLocal' instead"),this.addGlobal(t)},addToLocalAndGlobal:function(t){this.addGlobal(t),this.addToLocal(t)},removeFromLocal:function(t){var e=this._geometries,i=e.indexOf(t);i>-1&&(e.splice(i,1),t.removeRC())},addToLocal:function(t){if(!(t instanceof st))throw new TypeError("Object should be a geomdata hodler");-1===this._geometries.indexOf(t)&&(t.addRC(),this._geometries.push(t)),t.layer||(t.layer=this)},addToDrawingList:function(t){for(var e=ht.__instancesValues[this.__layerID].drawingGeoms,i=0,n=0;n<e.length;n++)t===e[n]&&(i=!0);i||e.push(t)},setScalable:function(t){this.scalable=t,this.scalable.scalableScene.add(this.__objectContainer)},drawGeometry:function(t){if(this.__visible){if(t.removeEventWithContext(st.SELECT,this,this.onGeomSelect),t.removeEventWithContext(st.DESELECT,this,this.onGeomDeselect),t.removeEventWithContext(AnkaScalable.GeomDataHolder.MOVE_EDIT,this,this.onMoveStart),t.removeEventWithContext(AnkaScalable.GeomDataHolder.VERTEX_EDIT,this,this.onVertexEdit),t.removeEventWithContext(AnkaScalable.GeomDataHolder.VERTEX_EDIT_STOP,this,this.onVertexEditStop),t.removeEventWithContext(AnkaScalable.GeomDataHolder.CHANGE,this,this.onChangeGeom),t.removeEventWithContext(AnkaScalable.GeomDataHolder.MOVE_EDIT_STOP,this,this.onMoveEditStop),t.currentStatus===AnkaScalable.GeomDataHolder.STATUS.COMPLETED){var e=new(0,t.sampleClass)(this.scalable,t);e.enable(this.scalable.baseObject),e.setData(t.points,t.attributes,t.holes),e.setLayer(this),e.update(),e.stopDraw(),e.updateStyle(),e.addEvent(T.CLICK,this,this.onSGeomSelect),e.uniqueID=t.uniqueID,this.__objectContainer.add(e),this.__meshStorage[e.uniqueID]=e,t.isSelected()&&e.onSelect(),t.isVertexEditing()&&this._editVertexGDH(t),t.isMoveEditing()&&e.addEvent(T.MOUSE_DOWN,this,this.onMouseDownOnGeom),this.drawWalls(t,e),t.addEvent(AnkaScalable.GeomDataHolder.VERTEX_EDIT,this,this.onVertexEdit),t.addEvent(AnkaScalable.GeomDataHolder.VERTEX_EDIT_STOP,this,this.onVertexEditStop),t.addEvent(AnkaScalable.GeomDataHolder.CHANGE,this,this.onChangeGeom),t.addEvent(AnkaScalable.GeomDataHolder.MOVE_EDIT,this,this.onMoveStart),t.addEvent(AnkaScalable.GeomDataHolder.MOVE_EDIT_STOP,this,this.onMoveEditStop)}else{var i=new(0,t.sampleClass)(this.scalable,t);i.enable(this.scalable.baseObject),i.setData(t.points,t.attributes,t.holes),i.setLayer(this),i.update(),i.updateStyle(),i.addEvent(T.CLICK,this,this.onSGeomSelect),i.uniqueID=t.uniqueID,this.__objectContainer.add(i),this.__meshStorage[i.uniqueID]=i}t.addEvent(st.SELECT,this,this.onGeomSelect),t.addEvent(st.DESELECT,this,this.onGeomDeselect)}},onMoveStart:function(t){var e=t.target,i=this.__meshStorage[e.uniqueID];i&&i.addEvent(T.MOUSE_DOWN,this,this.onMouseDownOnGeom)},onPolygonMove:function(t){var e=this._sGeomOnDrag;if(e){var i=this.getGeomByUniqueID(e.uniqueID);if(!i)return console.warn("Data holde could not be found");var n=this.getTransformer(),o=this.scalable.baseObject,a=o.getGroundMaster(),s=a.canvasToCartesian(o.globalMouseOffsetX,o.globalMouseOffsetY,this._dragStartY);s&&n.position.set(s.x,s.y,s.z);var r=this._meshDragStartPos,l=a.posToLoc(s),h=l.lat-r.lat,c=l.lon-r.lon;this._meshDragStartPos=l,i.addOffset(c,h,0)}},onMouseUpOnGeom:function(t){var e=this.scalable.baseObject;e.getController().disable(!1),document.removeEventListener("mouseup",this.onMouseUpOnGeom),e.removeEvent(AnkaPanAPI.PanoGL.PRE_RENDER,this.onPolygonMove),this._draggingGeom=null,this._meshDragStartPos=null},onMouseDownOnGeom:function(t){var e=t.currentTarget,i=this.scalable.baseObject,n=i.getGroundMaster(),o=t.intersectPoint.y,a=n.canvasToCartesian(i.globalMouseOffsetX,i.globalMouseOffsetY,o);this._mouseDownPos=a,this._meshDragStartPos=n.posToLoc(a),this._firstPoint=this._meshDragStartPos,this._stopControlDrag(!0),this._dragStartY=o,this._sGeomOnDrag=e,i.addEvent(AnkaPanAPI.PanoGL.PRE_RENDER,this,this.onPolygonMove),document.addEventListener("mouseup",this.onMouseUpOnGeom)},onChangeGeom:function(t){var e=t.target,i=this.__meshStorage[e.uniqueID];i&&(i.setData(e.points,e.attributes),i.update(),this.setDirty())},onVertexEdit:function(t){var e=t.target;this._editVertexGDH(e),this.setDirty()},onVertexEditStop:function(t){var e=this.scalable.baseObject;("function"!=typeof e.getDrawingPlugin||e.getDrawingPlugin()).stopGeometryVertexEdit(),this.setDirty()},onMoveEditStop:function(t){this.hideTransformer(),this.setDirty()},_editVertexGDH:function(t){var e=this.scalable.baseObject,i="function"!=typeof e.getDrawingPlugin||e.getDrawingPlugin();if(!i)throw new Error("AnkaDraw plugin could not be found!");var n=this.__meshStorage[t.uniqueID];n&&i.editGeometryVertices(n,t)},redraw:function(){if(this.__visible){if(this.findAndSetState(),this.removeAllChildren(),this.scalable)for(var t=this._geometries,e=0;e<t.length;e++)this.drawGeometry(t[e]);for(var i=ht.__instancesValues[this.__layerID].drawingGeoms,n=0;n<i.length;n++)this.drawGeometry(i[n]);this.setDirty()}},clearAllDrawingData:function(){ht.__instancesValues[this.__layerID].drawingGeoms.length=0;for(var t=ht.__instances[this.__layerID],e=0;e<t.length;e++)t[e].clearDrawingData()},clearDrawingData:function(){for(var t,e=this.__objectContainer.children,i=[],n=0;n<e.length;n++)(t=e[n])._commonGeom&&t._commonGeom.isDrawnData&&i.push(t);for(var o=0;o<i.length;o++)(t=i[o])._commonGeom&&t._commonGeom.isDrawnData&&(this.__objectContainer.remove(t),t.destroy());this.setDirty()},refresh:function(){ht.__instancesValues[this.__layerID].commonGeometries.length=0,this.removeAllChildren();for(var t=ht.__instances[this.__layerID],e=0;e<t.length;e++)t[e].redraw(!0)},drawWalls:function(t,e){if(this.isWallLayer){this.__wallGeometries||(this.__wallGeometries=[]);var i=[];if(t.sampleClass.isMultiGeom)for(var n=0;n<t.points.length;n++){for(var o=0;o<t.points[n].length;o++){var a=t.points[n][o],s=this.scalable.calculatePointPositionFromLonLatAlt(a.lon,a.lat,a.alt);i.push(new THREE.Vector3(s.x,s.y,s.z))}if(t.sampleClass===AnkaScalable.SMultiPolygon){var r=t.points[n][0],l=t.points[n][t.points[n].length-1];if(r.lat!==l.lat||r.lon!==l.lon||r.alt!==l.alt){var h=r,c=this.scalable.calculatePointPositionFromLonLatAlt(h.lon,h.lat,h.alt);i.push(new THREE.Vector3(c.x,c.y,c.z))}}}else{for(var u=0;u<t.points.length;u++){var p=t.points[u],f=this.scalable.calculatePointPositionFromLonLatAlt(p.lon,p.lat,p.alt);i.push(new THREE.Vector3(f.x,f.y,f.z))}if(t.sampleClass===AnkaScalable.SPolygon){var d=t.points[0],y=t.points[t.points.length-1];if(d.lat!==y.lat||d.lon!==y.lon||d.alt!==y.alt){var m=d,g=this.scalable.calculatePointPositionFromLonLatAlt(m.lon,m.lat,m.alt);i.push(new THREE.Vector3(g.x,g.y,g.z))}}}var v=new THREE.MeshBasicMaterial({color:65280,transparent:!0,opacity:.3,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1}),b=new rt(i),_=new THREE.Mesh(b,v);this.__wallGeometries.push(_),this.scalable.baseObject.addWall(_)}},findAndSetState:function(){ht.__instancesValues[this.__layerID].currentState!==this.getState()&&this.setState(ht.__instancesValues[this.__layerID].currentState)},selectgeomIfExist:function(){console.warn("Layer::selectgeomIfExist deprecated")},clearSelection:function(){this._selectedGDH&&this._deselectGeom(this._selectedGDH)},_deselectGeom:function(t){this.__moveEnabled?this.hideTransformer():this.__currentState===ht.STATES.VERTEX_EDIT&&this.__drawingPlugin.stopGeometryVertexEdit(),this._selectedGDH=null,t.setSelection(!1),this.setDirty()},_selectGeom:function(t){if(this.clearSelection(),this.__moveEnabled){var e=this.__meshStorage[t.uniqueID],i=this.getTransformer();this._groundPositionY=this.__getHitYPos(e);var n=this.posOnGround();n&&(i.position.set(n.x,n.y,n.z),this.__mouseDownPos=n)}else if(this.__currentState===ht.STATES.VERTEX_EDIT){var o=this.__meshStorage[t.uniqueID];this.__drawingPlugin.editGeometryVertices(o,t)}this._selectedGDH=t,t.setSelection(!0),this.setDirty()},__getHitYPos:function(t){var e=this.__getRay().intersectObjects(t.children);return 0===e.length?0:e[0].point.y},___hideOtherAnchors:function(){for(var t=ht.__instances[this.__layerID],e=0;e<t.length;e++){var i=t[e];i!==this&&i.hideTransformer()}},_stopControlDrag:function(t){this.scalable.baseObject.getController().disable(t)},_updateOtherInstanceGeometries:function(t){for(var e=t.attributes[this.__keyID],i=ht.__instances[this.__layerID],n=0;n<i.length;n++){var o=i[n];if(o!==this){var a=o.getGeomByKeyID(this.__keyID,e),s=o.__meshStorage[a.uniqueID];a.cloneFrom(t),s.setData(a.points,a.attributes,a.holes),s.update(),o.setDirty()}}},_throwEventForAllInstances:function(t,e){for(var i=ht.__instances[this.__layerID],n=0;n<i.length;n++){var o=i[n],a={};for(var s in e)a[s]=e[s];a.layer=o,o.throwEvent(a)}},getTransformer:function(){if(!this.__anchorMesh){var t=new THREE.BoxBufferGeometry(7,3,7,1,1,1);this.__anchorMesh=new THREE.Mesh(t,new THREE.MeshBasicMaterial({color:16711680}));var e=new THREE.BoxBufferGeometry(1,30,1,1,1,1),i=new THREE.Mesh(e,new THREE.MeshBasicMaterial({color:16776960}));i.position.set(0,15,0),this.__anchorMesh.add(i);var n=new a(new THREE.ConeBufferGeometry(5,20,80),new THREE.MeshBasicMaterial({color:65280}));this.__anchorMesh.add(n),n.position.set(0,40,0);var o=this.scalable.baseObject;n.setClickable(!0,o,null,o.getMainCamera()),n.addEvent(AnkaPanAPI.MeshMousePicker.MOUSE_DOWN,this,this.onAnchorDown)}return this.__anchorMesh.parent||this.__objectContainer.add(this.__anchorMesh),this.__anchorMesh.visible=!0,this.__anchorMesh},__getRay:function(){var t=this.scalable.baseObject,e=t.getMainCamera(),i=t.globalMouseOffsetX,n=t.globalMouseOffsetY,o=t.getRendererDom(),a=new THREE.Vector2;return a.x=i/o.width*2-1,a.y=-n/o.height*2+1,this._raycasterForMouse||(this._raycasterForMouse=new THREE.Raycaster),this._raycasterForMouse.setFromCamera(a,e),this._raycasterForMouse},__getRayDirection:function(){return this.__getRay().ray.direction},onAnchorDown:function(t){this._stopControlDrag(!0);var e=this.scalable.baseObject;this.__onAnchorMouseYPos=this.getAnchorPos(),e.addEvent(AnkaPanAPI.PanoGL.PRE_RENDER,this,this.onAnchorMove),document.addEventListener("mouseup",this.releaseAnchor)},onAnchorMove:function(t){var e=this.scalable.baseObject,i=this.getAnchorPos(),n=this._sGeomOnDrag,o=this.getGeomByUniqueID(n.uniqueID);if(o){var a=this.getTransformer(),s=i-this.__onAnchorMouseYPos,r=s/this.scalable.camHegInPix*this.scalable.camHegInMet;a.position.y+=s;var l=0,h=e.getCurrentPoint();h&&(l=h.altitude-this.scalable.camHegInMet),o.addOffset(0,0,r,l),this.__onAnchorMouseYPos=i}else console.log("Geometry not found")},releaseAnchor:function(t){var e=this.scalable.baseObject;this._stopControlDrag(!1),document.removeEventListener("mouseup",this.releaseAnchor),e.removeEvent(AnkaPanAPI.PanoGL.PRE_RENDER,this.onAnchorMove),this.setDirty()},getAnchorPos:function(){var t=this.__getRayDirection().y,e=this.getTransformer(),i=new THREE.Vector3;i.setFromMatrixPosition(e.matrixWorld);var n=Math.sqrt(i.x*i.x+0+i.z*i.z),o=Math.asin(t);return n*Math.tan(o)},hideTransformer:function(){this.__anchorMesh&&(this.__anchorMesh.visible=!1,this.__anchorMesh.parent&&this.__anchorMesh.parent.remove(this.__anchorMesh))},getLayerInstances:function(){return ht.__instances[this.__layerID]},posOnGround:function(){var t=this.scalable.baseObject,e=t.getMainCamera(),i=t.getRendererDom(),n=new THREE.Vector3,o=new THREE.Vector3(0,1,0),a=new THREE.Raycaster,s=new THREE.Vector3(0,-this.___groundPositionY,0);n.x=t.globalMouseOffsetX/i.clientWidth*2-1,n.y=-t.globalMouseOffsetY/i.clientHeight*2+1,a.setFromCamera(n,e);var r=-(o.dot(e.position)-o.dot(s))/o.dot(a.ray.direction),l=new THREE.Vector3;return l.x=e.position.x-a.ray.direction.x*r,l.y=e.position.y-a.ray.direction.y*r,l.z=e.position.z-a.ray.direction.z*r,l},getGeomByKeyID:function(t,e){for(var i=0;i<this._geometries.length;i++){var n=this._geometries[i];if(void 0!==e&&n.attributes[t]===e)return n}for(var o=ht.__instancesValues[this.__layerID].drawingGeoms,a=0;a<o.length;a++)if(e===o[a].attributes[t])return o[a];for(var s=ht.__instancesValues[this.__layerID].commonGeometries,r=0;r<s.length;r++)if(e===s[r].attributes[t])return s[r]},onSGeomSelect:function(t){var e=t.currentTarget,i=this.getGeomByUniqueID(e.uniqueID),n=function(t,e,i,n){return{type:t,target:e,layer:i,gdh:n}}(ht.FEATURE_CLICK,e,this,i);this.throwEvent(n)},_setGeomSelect:function(t){var e=t.attributes[this.__keyID],i=this.getGeomByKeyID(this.__keyID,e);i||(i=this.getGeomByUniqueID(t.uniqueID));for(var n=i.isSelected(),o=ht.__instances[this.__layerID],a=0;a<o.length;a++){var s=o[a];s.clearSelection();var r=s.getGeomByKeyID(this.__keyID,e);r&&(n?(ht.__instancesValues[s.__layerID].selectedKeyValue=null,s.selectedKeyValue=null,s._deselectGeom(r)):(ht.__instancesValues[s.__layerID].selectedKeyValue=e,s.selectedKeyValue=e,s._selectGeom(r)),r.notifyClick(),s.setDirty())}},getGeomByUniqueID:function(t){for(var e=0;e<this._geometries.length;e++)if(t===this._geometries[e].uniqueID)return this._geometries[e];for(var i=ht.__instancesValues[this.__layerID].drawingGeoms,n=0;n<i.length;n++)if(t===i[n].uniqueID)return i[n];for(var o=ht.__instancesValues[this.__layerID].commonGeometries,a=0;a<o.length;a++)if(t===o[a].uniqueID)return o[a]},setDirty:function(){this.scalable.setDirty()},setStyleKey:function(t){this._styleKey=t},getStyle:function(t){var e=this.__style,i=this._styleKey;if("string"==typeof i){var n=t.attributes[i];return"object"===lt(e[n])?e[n]:e.default?e.default:e}return e},selectedGeomByKeyID:function(t,e){console.warn("selectedGeomByKeyID deprecated");var i=this.getGeomByKeyID(this.__keyID,t);return i&&(this._setGeomSelect(i),this.scalable.setDirty()),i},getLayerKey:function(){return this.__keyID},onGeomSelect:function(t){for(var e,i=t.target,n=this.__objectContainer.children,o=0;o<n.length;o++)if(i.uniqueID===n[o].uniqueID){e=i,n[o].onSelect();break}this.throwEvent({type:ht.SELECT_FEATURE,target:e,layer:this})},onGeomDeselect:function(t){for(var e,i=t.target,n=this.__objectContainer.children,o=0;o<n.length;o++)i.uniqueID===n[o].uniqueID&&(e=i,n[o].onDeSelect());this.throwEvent({type:ht.DESELECT_FEATURE,target:e,layer:this})},getGeomListClone:function(){return this._geometries.concat()},resetGeomList:function(){this._geometries.length=0},removeGeomDatas:function(t){for(var e=ht.__instancesValues[this.__layerID].commonGeometries,i=0;i<t.length;i++){var n=t[i];if(n.removeRC(),!n.hasReferance()){var o=e.indexOf(n);e.splice(o,1)}}},removeConnectedChildren:function(t){var e=this.__meshStorage[t.uniqueID];e&&(this.__objectContainer.remove(e),e.destroy())},removeAll:function(){for(var t=ht.__instancesValues[this.__layerID].commonGeometries,e=0;e<this._geometries.length;e++){var i=this._geometries[e],n=t.indexOf(i);if(n>-1){var o=t[n];o.removeRC(),o.hasReferance()||t.splice(n,1)}}this._geometries.length=0},removeAllChildren:function(){if(this.__wallGeometries)for(var t,e=0;e<this.__wallGeometries.length;e++)t=this.__wallGeometries[e],this.scalable.baseObject.removeWall(t),t.material.dispose(),t.geometry.dispose(),t.parent&&t.parent.remove(t);this.__anchorMesh&&this.__anchorMesh.parent&&this.__anchorMesh.parent.remove(this.__anchorMesh),this.__meshStorage={};for(var i=this.__objectContainer.children;i.length>0;){var n=i[0];this.__objectContainer.remove(n),n.destroy()}this.setDirty()},destroy:function(){var t=ht.__instances[this.__layerID].indexOf(this);t>-1&&ht.__instances[this.__layerID].splice(t,1);for(var e=0;e<this._geometries.length;e++)this._geometries[e].removeRC();this.removeUnusedGeometries()},removeUnusedGeometries:function(){for(var t=ht.__instancesValues[this.__layerID].commonGeometries,e=0;e<t.length;e++){var i=t[e];if(!i.hasReferance()){var n=t.indexOf(i);t.splice(n,1)}}},setState:function(t){this.__currentState!==t&&(this.__currentState===ht.STATES.NORMAL||(this.__currentState===ht.STATES.MOVE?this.__disableMove():this.__currentState===ht.STATES.VERTEX_EDIT&&this.__disableVertexEdit()),this.__currentState=t,this.__currentState===ht.STATES.NORMAL||(this.__currentState===ht.STATES.MOVE?this.__enableMove():this.__currentState===ht.STATES.VERTEX_EDIT&&this.__enableVertexEdit()))},getOpacity:function(){return this.__layerOpacity},setOpacity:function(t){this.__layerOpacity=t;for(var e=this.__objectContainer.children,i=0;i<e.length;i++)e[i].updateStyle();this.scalable.setDirty()},__enableVertexEdit:function(){var t=this.scalable.baseObject;if(t.getDrawingPlugin&&(this.__drawingPlugin=t.getDrawingPlugin()),!this.__drawingPlugin)return console.warn("Vertext edit mode requires DrawingPlugin. Using without it may harm your software"),void this.__disableVertexEdit();var e=t.getGroundMaster();t.setArrowVisibility(!1),t.disableGroundNav(!0),e.disableNavigation(),e.disableWallIntersection(),this.clearSelection()},__disableVertexEdit:function(){var t=this.scalable.baseObject,e=t.getGroundMaster();t.setArrowVisibility(!0),t.disableGroundNav(!1),e.enableNavigation(),this.clearSelection(),e.enableWallIntersection(),this.hideTransformer()},getState:function(){return this.__currentState},setStatesForAllInstances:function(t){ht.__instancesValues[this.__layerID].currentState=t;for(var e=ht.__instances[this.__layerID],i=0;i<e.length;i++){e[i].setState(t)}},__disableMove:function(){this.__moveEnabled=!1;var t=this.scalable.baseObject,e=t.getGroundMaster();t.setArrowVisibility(!0),t.disableGroundNav(!1),e.enableNavigation(),this.clearSelection(),this.hideTransformer()},__enableMove:function(){this.__moveEnabled=!0;var t=this.scalable.baseObject,e=t.getGroundMaster();t.setArrowVisibility(!1),t.disableGroundNav(!0),e.disableNavigation(),this.clearSelection()},setLabelTextSample:function(t){this.__labelTextSample=t},getLabelTextSample:function(){return this.__labelTextSample},getLabelText:function(t){var e=this.getLabelTextSample();return AnkaPanAPI.Utils.ParseLabelString(e,t).toString()},getGeometries:function(){return this._geometries}});var ut={lineWidth:3,lineColor:16711935};function pt(t){return(pt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function ft(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function dt(t,e){return(dt=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function yt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,n=gt(t);if(e){var o=gt(this).constructor;i=Reflect.construct(n,arguments,o)}else i=n.apply(this,arguments);return mt(this,i)}}function mt(t,e){if(e&&("object"===pt(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function gt(t){return(gt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}ct.prototype=Object.assign(Object.create(ht.prototype),{constructor:ct,redraw:function(){if(this.visible){this.resetGeomList();var t=ht.__instancesValues[this.__layerID].commonGeometries;this._geometries=t.concat(),ht.prototype.redraw.apply(this,arguments)}this.scalable.setDirty()},getStyle:function(t){return!t||"Line"!==t.type&&"MultiLine"!==t.type?ht.prototype.getStyle.apply(this,[t]):ut},refresh:function(){this.removeAllChildren();for(var t=ht.__instances[this.__layerID],e=0;e<t.length;e++)t[e].redraw(!0)},removeFromCommonList:function(t){var e=ht.__instancesValues[this.__layerID].commonGeometries,i=e.indexOf(t);i>-1&&e.splice(i,1)},removeConnectedChildren:function(t){for(var e=this.getLayerInstances(),i=0;i<e.length;i++)ht.prototype.removeConnectedChildren.apply(e[i],arguments)},clearAll:function(){ht.__instancesValues[this.__layerID].commonGeometries.length=0;for(var t=this.getLayerInstances(),e=0;e<t.length;e++)t[e].removeAllChildren(),t[e].scalable.setDirty()}});var vt="onNewGeometriesAdd",bt="onGeomRemove",_t=[],Et=!0,Tt=new(function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&dt(t,e)}(a,t);var e,i,n,o=yt(a);function a(){var t;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,a),t=o.call(this),!Et)throw new Error("GeometryObserver instance cannot be created more than once");return Et=!1,t}return e=a,(i=[{key:"addGeometries",value:function(t){if(!Array.isArray(t))throw new Error("Parameter can be only Array<GeomDataHolder>");var e=[];t.forEach((function(t){-1===_t.indexOf(t)&&(e.push(t),_t.push(t))})),e.length>0&&this.throwEvent({type:vt,geometries:e})}},{key:"removeGeometry",value:function(t){var e=_t.indexOf(t);if(e>-1){var i=_t.splice(e,1)[0];this.throwEvent({type:bt,target:i})}}}])&&ft(e.prototype,i),n&&ft(e,n),Object.defineProperty(e,"prototype",{writable:!1}),a}(l));i(2),i(3),i(4),i(5),i(6);function wt(t){if(AnkaPanAPI.PanoPlugin.apply(this,arguments),wt._instances.push(this),this._roll=0,this._heading=0,this._pitch=0,this._tempraryPolygons=[],this._points=[],this._lines=[],this._layers=[],this.ClassInstance=wt,this.initialOptions=t,t)for(var e in t)this["_"+e]=t[e];Tt.addEvent(vt,this,this._onGeomAddedToPool),Tt.addEvent(bt,this,this._onGeomRemoved)}function St(t,e,i,n,o,a){this.geomField=n,this.__ajaxObject=i,ht.apply(this,[t,e,o,a])}function Pt(t,e,i,n,o,a){this.serviceURL=e,ht.apply(this,[t,n,o,a]),this.setLabelTextSample("#"+n),this.token=i;var s=e+"?f=json";if(i&&(s+="&token="+i),ht.__instances[this.__layerID].length>1&&ht.__instances[this.__layerID][0].layerInfo)this.setParameters(ht.__instances[this.__layerID][0].layerInfo);else{var r=this,l=$.ajax({url:s,dataType:"json"});l.done((function(t){r.setParameters(t)})),l.fail((function(t){console.log(t)}))}}function Mt(t){return(Mt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function Dt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Ht(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function Ct(){return(Ct="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var n=At(t,e);if(n){var o=Object.getOwnPropertyDescriptor(n,e);return o.get?o.get.call(arguments.length<3?t:i):o.value}}).apply(this,arguments)}function At(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=Gt(t)););return t}function xt(t,e){return(xt=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function Rt(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,n=Gt(t);if(e){var o=Gt(this).constructor;i=Reflect.construct(n,arguments,o)}else i=n.apply(this,arguments);return Lt(this,i)}}function Lt(t,e){if(e&&("object"===Mt(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function Gt(t){return(Gt=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}wt.version="1.0.1",wt.GEOM_SELECT="onGeomSelect",wt.GEOM_DESELECT="onGeomDeSelect",wt.GEOM_CLICK="onGeomClick",wt.SAVE_CONFIG="onSaveConfig",wt.prototype=Object.create(AnkaPanAPI.PanoPlugin.prototype),wt.prototype.constructor=wt,wt._instances=[],wt.prototype._onGeomAddedToPool=function(t){for(var e=t.geometries,i=0;i<e.length;i++){var n=e[i];n.isCompleted()?this.addGDH(n):n.isDrawing()&&(this.addGDH(n),n.addEvent(st.CHANGE,this,this._onChangeGeomDataHolder))}},wt.prototype._onGeomRemoved=function(t){var e=t.target;e.layer instanceof ht?(e.layer.removeFromGlobal(e),e.layer.redraw()):console.warn("Geomtry doesn't have a defined layer")},wt.prototype._onChangeGeomDataHolder=function(t){var e=t.target,i=e.layer;e.isCompleted()&&e.removeEvent(st.CHANGE,this._onChangeGeomDataHolder),i.redraw()},wt.prototype.addGDH=function(t){var e=t.layer||this.getMainSketchLayer();t.layer=e,e.addToList(t)},wt.prototype.getMainSketchLayer=function(){var t=this.__sketchLayer;return t||((t=new ct("sketchLayer","__uniqueID")).setScalable(this),t.setMouseEnable(!0),t.isSketchLayer=!0,t.redraw(!0),this.__sketchLayer=t),t},wt.prototype.prepare=function(){var t=this;this.baseObject.getScalable=function(){return t},t.scalableScene=new THREE.Scene;for(var e=new THREE.TextureLoader,i=e.load("img/grid.png",(function(e){t.setDirty()})),n=this.baseObject.getPlugins(),o=0;o<n.length;o++){if(n[o]instanceof AnkaSoftText.SoftTextPlugin){this.softText=n[o];break}}this.softText||console.log("SoftTextPlugin bulunamadı. label sahne üzerinde gösterilemeyebilir."),i.generateMipmaps=!1,i.magFilter=THREE.LinearFilter,i.minFilter=THREE.LinearFilter;var a=new THREE.MeshBasicMaterial({map:i,transparent:!0,opacity:.9}),s=new THREE.SphereBufferGeometry(1001,64,64);t.gridSphere=new THREE.Mesh(s,a),t.gridSphere.scale.set(-1,1,1);var r=e.load("img/straight.png",(function(e){t.setDirty()}));r.generateMipmaps=!1,r.magFilter=THREE.NearestFilter,r.minFilter=THREE.NearestFilter;var l=new THREE.SphereBufferGeometry(1e3,64,64),h=new THREE.MeshBasicMaterial({map:r,transparent:!0,opacity:.6});t.lineScene=new THREE.Mesh(l,h),t.lineScene.scale.set(-1,1,1),this.softRenderCounter=3,this.createPlane();var c=AnkaPanAPI.PanoGL;t.baseObject.addEvent(c.DATA_COMPLETE,t,t.onDataComplate),t.baseObject.addEvent(c.LOCATION_CHANGE,t,t.onThumbComplete),t.baseObject.addEvent(c.RENDER_AFTER_GROUND,t,t.renderAfterGround),t.baseObject.initialized?this.panoSetupCompleted():t.baseObject.addEvent(c.SETUP_COMLETE,this,(function(){this.panoSetupCompleted()}))},wt.prototype.addLayer=function(t){t instanceof ht?(this._layers.push(t),t.setScalable(this)):console.error("Object is not instance of AnkaScalable.Layer")},wt.prototype.getLayers=function(){return this._layers},wt.prototype.removeLayer=function(t){if(t instanceof ht){var e=this._layers.indexOf(t);if(e>-1)this._layers[e].removeAllChildren(),this._layers.splice(e,1)}else console.error("Object is not instance of AnkaScalable.Layer")},wt.prototype.panoSetupCompleted=function(){var t=this.baseObject.getGroundMaster();t.addEvent(AnkaPanAPI.GroundMaster.CAMERA_ORIENTATION_CHANGE,this,this.onCameraOrientationChange),t.addEvent(AnkaPanAPI.GroundMaster.CAMERA_HEIGHT_CHANGE,this,this.onCameraHeightChange)},wt.prototype.updateAliveGeom=function(){var t=wt.activeGeomDataHolder;if(!this.activeGeom||t.uniqueID===this.activeGeom.uniqueID){this.activeGeom&&this.activeGeom.destroy();var e=t.sampleClass;this.activeGeom=new e(this,t),this.activeGeom.enable(this.baseObject),this.activeGeom.setData(t.points,t.attributes),this.activeGeom.uniqueID=t.uniqueID,this.activeGeom.setLayer(t.layer),this.scalableScene.add(this.activeGeom),this.activeGeom.updateStyle(),t.addEvent(st.CHANGE,this,this.onActiveGeomChanged)}},wt.prototype.destroyActiveGeometry=function(){this.activeGeom&&this.activeGeom.destroy();var t=wt.activeGeomDataHolder;t&&t.removeEvent(st.CHANGE,this.onActiveGeomChanged),this.activeGeom=null,wt.activeGeomDataHolder=null},wt.prototype.destroyActiveGeometryForAllInstance=function(){for(var t=0;t<wt._instances.length;t++)wt._instances[t].destroyActiveGeometry()},wt.prototype.onActiveGeomChanged=function(t){var e=t.target;e.dynamicPoint&&this.activeGeom.setDynamicPoint(e.dynamicPoint),this.activeGeom.setData(e.points,e.attributes),this.activeGeom.update(),e.getStatus()===st.STATUS.COMPLETED?(this.activeGeom.stopDraw(),this.activeGeom.update(),e.addEvent(st.CLICK,this,this.onGeomDataHolderClicked),e.addEvent(st.SELECT,this,this.onGeomDataHolderSelected),e.addEvent(st.DESELECT,this,this.onGeomDataHolderDeSelected),e.removeEventWithContext(st.CHANGE,this,this.onActiveGeomChanged),this._tempraryPolygons.push(this.activeGeom)):e.getStatus()===st.STATUS.BAD_COMPLETED&&(this.activeGeom&&(this.activeGeom.destroy(),this.activeGeom=null),e.removeEventWithContext(st.CHANGE,this,this.onActiveGeomChanged))},wt.prototype.disableMouse=function(){this.scalableScene.mouseDisabled=!0},wt.prototype.enableMouse=function(){this.scalableScene.mouseDisabled=!1},wt.prototype.getCurrentAltitude=function(){return this.currentData.current.altitude-this.camHegInMet},wt.prototype.mouseMoveOnBaseDiv=function(){this.baseObject.setSoftCanvasDirty(),this.softRenderCounter=4},wt.prototype.onCameraOrientationChange=function(){this.redrawGeometries()},wt.prototype.onCameraHeightChange=function(t){this.camHegInMet=t.meter,this.camHegInPix=t.pixel,this.plane.position.set(0,-t.pixel,0)},wt.prototype.redrawGeometries=function(){for(var t=this._points,e=0;e<t.length;e++){var i=this.calculatePointPositionFromLonLatAlt(t[e].lon,t[e].lat,t[e].alt);t[e].m.position.set(i.x,i.y,i.z),t[e].m.reset()}},wt.prototype.addPoint=function(t,e,i,n){var o=new w(this);return o.enable(this.baseObject),this.scalableScene.add(o),o.setLocation(t,e,i),o.reset(),n||this._points.push(o),o},wt.prototype.addLine=function(t){for(var e=t.replace("MULTILINESTRING ZM ","").replace("((","").replace("))","").split(","),i=[],n=0;n<e.length;n++){var o=e[n].split(" "),a={lon:o[0],lat:o[1],alt:o[2]};i.push(a)}var s=new G(this);s.enable(this.baseObject),s.setPoints(i),this.scalableScene.add(s),this._lines.push(s)},wt.prototype.selectGeometry=function(t){this.selectionMat||(this.selectionMat=new THREE.MeshBasicMaterial({color:65535,depthWrite:!1,depthTest:!1,transparent:!0,opacity:.6}));var e=t.target,i=t.parentTarget,n=e.geometry,o=new THREE.Mesh(n,this.selectionMat);this.selected=e,this.scalableScene.updateMatrixWorld(),o.position.setFromMatrixPosition(e.matrixWorld),o.scale.setFromMatrixScale(e.matrixWorld),o.rotation.setFromRotationMatrix(e.matrixWorld),o.scale.multiplyScalar(1.1);var a=new THREE.Geometry;a.vertices.push(new THREE.Vector3(i.position.x,i.position.y,i.position.z),new THREE.Vector3(0,.2,0));var s=new THREE.Line(a,this.selectionMat);this.scalableScene.add(o),this.scalableScene.add(s)},wt.prototype.calculatePointPositionFromLonLatAlt=function(t,e,i){if(!this.currentData||!this.currentData.current)return{x:t,y:e,z:i=void 0===i||isNaN(i)?0:i};i=void 0===i||isNaN(i)?this.getCurrentAltitude():i;var n=AnkaPanAPI.Utils,o=this.currentData.current,a=n.bearing(o.lat,o.lon,e,t)%360,s=a=(360-a)%360,r=n.heversine(o.lat,e,o.lon,t)*Math.abs(this.camHegInPix)/this.camHegInMet,l=(360-(s+90))/180*Math.PI,h=(i-o.altitude)*Math.abs(this.camHegInPix)/this.camHegInMet;return{x:r*Math.cos(l),y:h,z:r*Math.sin(l)}},wt.prototype.fromLonLatAlt=function(t,e,i){if(!this.currentData||!this.currentData.current)return null;i=void 0===i||isNaN(i)?this.getCurrentAltitude():i;var n=AnkaPanAPI.Utils,o=this.currentData.current,a=n.bearing(o.lat,o.lon,e,t)%360,s=a=(360-a)%360,r=n.heversine(o.lat,e,o.lon,t)*Math.abs(this.camHegInPix)/this.camHegInMet,l=(360-(s+90))/180*Math.PI,h=(i-o.altitude)*Math.abs(this.camHegInPix)/this.camHegInMet;return{x:r*Math.cos(l),y:h,z:r*Math.sin(l)}},wt.prototype.toLonLatAlt=function(t,e,i){return this.baseObject.groundMaster.posToLoc({x:t,y:e,z:i})},wt.loc2Pos=function(t,e,i,n,o,a){n=void 0===n?t.altitude:n;var s=AnkaPanAPI.Utils,r=s.bearing(t.lat,t.lon,i,e)%360,l=r=(360-r)%360,h=s.heversine(t.lat,i,t.lon,e)*Math.abs(o)/a,c=(360-(l+90))/180*Math.PI,u=(n-t.altitude)*Math.abs(o)/a;return{x:h*Math.cos(c),y:u,z:h*Math.sin(c)}},wt.prototype.createPlane=function(){var t=new THREE.TextureLoader,e=this,i=t.load("img/grid_t.png",(function(t){e.setDirty()})),n=new THREE.MeshBasicMaterial({opacity:.5,transparent:!0,map:i});i.wrapS=i.wrapT=THREE.RepeatWrapping,i.repeat.set(50,50),i.minFilter=THREE.LinearFilter;var o=new THREE.Geometry,a=1e3,s=new THREE.Vector3(-a,0,-a),r=new THREE.Vector3(a,0,-a),l=new THREE.Vector3(a,0,a),h=new THREE.Vector3(-a,0,a);o.vertices.push(s),o.vertices.push(r),o.vertices.push(l),o.vertices.push(h),o.faces.push(new THREE.Face3(2,1,0)),o.faces.push(new THREE.Face3(0,3,2));var c=[new THREE.Vector2(1,1),new THREE.Vector2(1,0),new THREE.Vector2(0,0)],u=[new THREE.Vector2(0,0),new THREE.Vector2(0,1),new THREE.Vector2(1,1)];o.faceVertexUvs[0]=[],o.faceVertexUvs[0].push(c),o.faceVertexUvs[0].push(u),this.plane=new THREE.Mesh(o,n),this.plane.position.set(0,-100,0)},wt.prototype.renderAfterGround=function(t){var e=this.baseObject,i=e.getRenderer(),n=e.getMainCamera();i.clearDepth(),i.render(this.scalableScene,n)},wt.prototype.getStandingPoint=function(){return this._standingLatlon},wt.prototype.getBasePano=function(){return this.baseObject},wt.prototype.onDataComplate=function(t){var e=t.data;this.setCameraHeight(e.rawData.config.camheight),this.currentData=e,this._standingLatlon=e.current},wt.prototype.refresh=function(t){this.redrawLayers(t),this.updateSavedGeoms(t)},wt.prototype.redrawLayers=function(t){for(var e=0;e<this._layers.length;e++)this._layers[e].redraw(t);this.getMainSketchLayer().redraw(t),this.setDirty()},wt.prototype.updateSavedGeoms=function(t){this.setDirty()},wt.prototype.updateSavedGeomsSyncron=function(){for(var t=0;t<wt._instances.length;t++)wt._instances[t].updateSavedGeoms()},wt.prototype.onGeomDataHolderClicked=function(t){this.throwEvent({type:wt.GEOM_CLICK,target:t.target})},wt.prototype.onGeomDataHolderSelected=function(t){for(var e=0;e<this._tempraryPolygons.length;e++)if(this._tempraryPolygons[e].uniqueID===t.target.uniqueID){this._tempraryPolygons[e].onSelect();break}this.throwEvent({type:wt.GEOM_SELECT,target:t.target}),this.baseObject.setDirty()},wt.prototype.onGeomDataHolderDeSelected=function(t){for(var e=0;e<this._tempraryPolygons.length;e++)if(this._tempraryPolygons[e].uniqueID===t.target.uniqueID){this._tempraryPolygons[e].onDeSelect();break}this.throwEvent({type:wt.GEOM_DESELECT,target:t.target}),this.baseObject.setDirty()},wt.prototype.onThumbComplete=function(t){this.refresh(),this.updateOrientation()},wt.prototype.updateOrientation=function(t){if(this.currentData){var e=this.currentData.current,i=this.currentData.rawData.config,n=e.roll,o=e.pitch,a=e.heading;i&&(n-=void 0!==i.roll?i.roll:0,o-=void 0!==i.pitch?i.pitch:0,a-=void 0!==i.heading?i.heading:0);var s=a/180*Math.PI;this.plane.rotation.set(0,-(s-Math.PI),0),this.gridSphere.rotation.set(0,-(s+.5*Math.PI),0,"YXZ"),n-=this._roll,o-=this._pitch,a-=this._heading,this.baseObject.setOriantation(a,o,n)}else console.warn("data yüklenmemiş.")},wt.prototype.setOriantation=function(t,e,i){this._heading=t,this._pitch=e,this._roll=i,this.setDirty(),this.updateOrientation()},wt.prototype.setCameraHeight=function(t){var e=this.baseObject.getGroundMaster();this.camHegInMet=t,e.setCameraHeight(t),this.setDirty()},wt.prototype.getCameraHeight=function(){return this.camHegInMet},wt.prototype.getRoll=function(){return this._roll},wt.prototype.getHeading=function(){return this._heading},wt.prototype.getPitch=function(){return this._pitch},wt.prototype.setHeading=function(t){this._heading=t,this.setOriantation(this._heading,this._pitch,this._roll)},wt.prototype.setRoll=function(t){this._roll=t,this.setOriantation(this._heading,this._pitch,this._roll)},wt.prototype.setPitch=function(t){this._pitch=t,this.setOriantation(this._heading,this._pitch,this._roll)},wt.prototype.openControls=function(){var t=this;if(void 0===window.dat||void 0===window.dat.GUI){var e=document.createElement("script");e.onload=this.openControls.bind(this),e.src="libs/dat.gui.min.js",document.head.appendChild(e)}else{var i=new dat.GUI,n=i.domElement;n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.style.zIndex=9999,this.baseObject.contentDV.appendChild(n);var o=this,a={get Heading(){return o.getHeading()},set Heading(t){o.setHeading(t)},get Roll(){return o.getRoll()},set Roll(t){o.setRoll(t)},get Pitch(){return o.getPitch()},set Pitch(t){o.setPitch(t)},get"Camera Height"(){return o.getCameraHeight()},set"Camera Height"(t){o.setCameraHeight(t)}},s={Export:function(){var t=document.createElement("a"),e='{"roll":'+o.getRoll()+',"pitch":'+o.getPitch()+',"camheight":'+o.getCameraHeight()+',"heading":'+o.getHeading()+"}";t.href="data:text/plain;base64,"+window.btoa(e),t.textContent="download",t.download="setup.ank",t.click()},Destroy:function(){i.destroy()},Save:function(){var e=t.baseObject.dataParser.getCurrentConfig(),i={roll:o.getRoll()+e.roll,pitch:o.getPitch()+e.pitch,camheight:o.getCameraHeight(),heading:o.getHeading()+e.heading};t.throwEvent({type:wt.SAVE_CONFIG,data:i})}};i.add(a,"Heading",-360,360).step(.01),i.add(a,"Roll",-90,90).step(.01),i.add(a,"Pitch",-90,90).step(.01),i.add(a,"Camera Height",0,5).step(.01).listen(),i.add(s,"Export"),i.add(s,"Destroy"),i.add(s,"Save"),i.open()}return n},wt.wktToGeomData=function(t,e){var i=st,n=wt.getTypeClass(t),o=wt.getPoints(t),a=new i(n,o.geoms,e);return a.isMultiGeom=o.geomCount>1,a.holes=o.holes,a.setStatus(i.STATUS.COMPLETED),a},wt.addWKT=function(t){var e=wt.wktToGeomData(t),i=AnkaScalable.ScalablePlugin._instances[0],n=i.getMainSketchLayer(),o=n.addToList(e);return n.drawGeometry(e),i.setDirty(),o},wt.addGDH=function(t){Tt.addGeometries([t])},wt.getPoints=function(t){if(t)if(t.indexOf("MULTI")>-1){var e=/([A-Z])\w+/g,i=/\(|\)/g;if(t.indexOf("LINE")>-1){for(var n=[],o=t.replace(e,"").trim().split("),("),a=0;a<o.length;a++){for(var s=o[a].trim().replace(i,"").split(","),r=[],l=0;l<s.length;l++){var h=s[l].split(" "),c={lon:parseFloat(h[0]),lat:parseFloat(h[1]),alt:parseFloat(h[2])};r.push(c)}n.push(r)}return{geomCount:n.length,geoms:n}}if(t.indexOf("POLYGON")>-1){for(var u=[],p=t.replace(e,"").trim().split(")),(("),f=0;f<p.length;f++){for(var d=p[f].replace(i,"").trim().split(","),y=[],m=0;m<d.length;m++){var g=d[m].trim().split(" ");y.push({lon:parseFloat(g[0]),lat:parseFloat(g[1]),alt:parseFloat(g[2])})}u.push(y)}return{geomCount:1,geoms:u}}}else{var v=/\(|\)/g,b=t.replace(/([A-Z])\w+/g,"");if(t.indexOf("POINT")>-1){var _=b.replace(v,"").trim().split(" ");return{geomCount:1,geoms:[{lon:parseFloat(_[0]),lat:parseFloat(_[1]),alt:parseFloat(_[2])}]}}if(t.indexOf("LINE")>-1){for(var E=b.replace(v,"").trim().split(","),T=[],w=0;w<E.length;w++){var S=E[w].trim().split(" ");T.push({lon:parseFloat(S[0]),lat:parseFloat(S[1]),alt:parseFloat(S[2])})}return{geomCount:1,geoms:T}}if(t.indexOf("POLYGON")>-1){var P=b.split("),(");if(P.length>1){for(var M=P[0].replace(v,"").trim().split(","),D=[],H=0;H<M.length;H++){var C=M[H].trim().split(" ");D.push({lon:parseFloat(C[0]),lat:parseFloat(C[1]),alt:parseFloat(C[2])})}for(var A=[],x=1;x<P.length;x++){for(var R=P[x].replace(v,"").trim().split(","),L=[],G=0;G<R.length;G++){var O=R[G].trim().split(" ");L.push({lon:parseFloat(O[0]),lat:parseFloat(O[1]),alt:parseFloat(O[2])})}A.push(L)}return{geomCount:1,geoms:D,holes:A}}for(var k=b.replace(v,"").trim().split(","),I=[],j=0;j<k.length;j++){var N=k[j].trim().split(" ");I.push({lon:parseFloat(N[0]),lat:parseFloat(N[1]),alt:parseFloat(N[2])})}return{geomCount:1,geoms:I}}}},wt.prototype.destroy=function(){for(var t=0;t<this._layers.length;t++)this._layers[t].destroy()},wt.getTypeClass=function(t){if(t)if(t.indexOf("MULTI")>-1){if(t.indexOf("LINE")>-1)return AnkaScalable.SMultiLine;if(t.indexOf("POLYGON")>-1)return AnkaScalable.SMultiPolygon}else{if(t.indexOf("POINT")>-1)return AnkaScalable.SPoint;if(t.indexOf("LINE")>-1)return AnkaScalable.SLine;if(t.indexOf("POLYGON")>-1)return AnkaScalable.SPolygon}},St.prototype=Object.assign(Object.create(ht.prototype),{constructor:St,redraw:function(t){this.removeAllChildren();var e=this.scalable.baseObject.dataParser.currentPoint,i={lat:e.lat,lon:e.lon};if(this.__ajaxObject.data)for(var n in i)this.__ajaxObject.data[n]=i[n];else this.__ajaxObject.data=i;this.__ajax&&this.__ajax.abort();var o=this;this.__ajax=$.ajax(this.__ajaxObject),this.__ajax.done((function(e){var i=o.getGeomListClone();o.resetGeomList(),o.__ajax=null;for(var n=JSON.parse(e),a=0;a<n.length;a++){var s=n[a],r=s[o.geomField],l=wt.wktToGeomData(r);delete s[o.geomField],l.mergeAttributes(s),o.addToList(l)}o.removeGeomDatas(i),ht.prototype.redraw.apply(o,[t])})),this.__ajax.fail((function(t){o.__ajax=null,console.log(t)}))}}),Pt.prototype=Object.assign(Object.create(ht.prototype),{constructor:Pt,setParameters:function(t){if(t.error)console.log(t);else{var e=t;this.layerInfo=t,this.__keyID=e.objectIdField,"esriGeometryPoint"===e.geometryType?this.__typeClass=AnkaScalable.SPoint:"esriGeometryPolyline"===e.geometryType?this.__typeClass=AnkaScalable.SMultiLine:"esriGeometryPolygon"===e.geometryType&&(this.__typeClass=AnkaScalable.SMultiPolygon);var i=e.drawingInfo.renderer,n=i.uniqueValueInfos;if("simple"===i.type){var o=document.createElement("img"),a=i.symbol,s={};if(a.imageData){s.width=a.width,s.height=a.height,s.xoffset=a.xoffset,s.yoffset=a.yoffset;var r=new THREE.Texture(o);r.minFilter=THREE.LinearFilter,o.src="data:"+a.contentType+";base64,"+a.imageData,r.needsUpdate=!0,s.img=o;var l=new THREE.PlaneBufferGeometry(s.width,s.height,1,1);s.geometry=l,s.texture=r,this.defaultSymbol=s}else if(this.__typeClass===AnkaScalable.SMultiLine){var h=this.__style;h.lineWidth=a.width;var c=new THREE.Color(a.color[0]/255,a.color[1]/255,a.color[2]/255);h.lineColor=c.getHex(),h.lineOpacity=a.color[3]}else{var u=this.__style,p=new THREE.Color(a.color[0]/255,a.color[1]/255,a.color[2]/255);u.fillColor=p.getHex(),u.fillOpacity=a.color[3],u.lineWidth=a.outline.width;var f=new THREE.Color(a.outline.color[0]/255,a.outline.color[1]/255,a.outline.color[2]/255);u.lineColor=f.getHex(),u.lineOpacity=a.outline.color[3]}}else if(n){null!=i.field1&&(this.styleField=i.field1),this.__icons={};for(var d=0;d<n.length;d++){var y=n[d],m={};if(y.symbol.color){var g=y.symbol.color;m.lineColor=new THREE.Color(parseFloat(g[0])/255,parseFloat(g[1])/255,parseFloat(g[2])/255),m.width=y.symbol.width,m.lineOpacity=g[3]/255}else{m.width=y.symbol.width,m.height=y.symbol.height,m.xoffset=y.symbol.xoffset,m.yoffset=y.symbol.yoffset;var v=document.createElement("img"),b=new THREE.Texture(v);b.minFilter=THREE.LinearFilter,v.src="data:"+y.symbol.contentType+";base64,"+y.symbol.imageData,b.needsUpdate=!0,m.img=v;var _=new THREE.PlaneBufferGeometry(m.width,m.height,1,1);m.geometry=_,m.texture=b}this.__icons[y.value]=m}}this.renderer=i,this.getCurrentData()}},getStyle:function(t){if(t&&(null!=this.styleField&&t.attributes||void 0!==this.defaultSymbol)){if("simple"===this.renderer.type)return this.defaultSymbol;if(null!=this.styleField){var e=t.attributes[this.styleField];return this.__icons[e]?this.__icons[e]:this.__style}return this.__style}return this.__style},getCurrentData:function(){if(this.scalable){var t=this.scalable.baseObject.getCurrentPoint();if(t){var e=this.serviceURL+"/query?f=json"+"&returnGeometry=true"+'&geometry={"x": '+t.lon+',"y": '+t.lat+"}"+"&geometryType=esriGeometryPoint"+"&inSR=4326"+"&spatialRel=esriSpatialRelIntersects"+"&distance=30"+"&units=esriSRUnit_Meter"+"&outFields=*"+"&outSR=4326"+"&returnDistinctValues=false"+"&returnZ=false&returnM=false&token="+this.token+"&where=1=1",i=$.ajax({url:e,dataType:"json"}),n=this;i.done((function(t){n.createGeometries(t),n.__isWaitingForRequestData=!1})),i.fail((function(t){console.log(t)}))}else this.__isWaitingForRequestData=!0}},createGeometries:function(t){var e=this.getGeomListClone();if(this.resetGeomList(),t&&t.features)for(var i=0;i<t.features.length;i++){var n=t.features[i],o=n.attributes,a=n.geometry;if(this.__typeClass.isMultiGeom)this.__typeClass===AnkaScalable.SMultiLine?this.createPolyLine(a,o):this.__typeClass===AnkaScalable.SMultiPolygon&&this.createMultiPolygon(a,o);else{var s={lon:a.x,lat:a.y},r=new AnkaScalable.GeomDataHolder(this.__typeClass,[s],o);r.setStatus(AnkaScalable.GeomDataHolder.STATUS.COMPLETED),this.addToList(r)}}this.removeGeomDatas(e),ht.prototype.redraw.apply(this,[!0])},addToList:function(t){t.layer||(t.layer=this),void 0===t.getKeyValue(this.__keyID)&&(t.attributes[this.__keyID]=t.uniqueID),t.isDrawnData?this.addToDrawingList(t):ht.prototype.addToLocalAndGlobal.apply(this,[t])},createMultiPolygon:function(t,e){for(var i=[],n=t.rings,o=0;o<n.length;o++){i[o]=[];for(var a=0;a<n[o].length;a++){var s=n[o][a],r={lon:s[0],lat:s[1]};s.length>2?r.alt=s[2]:r.alt=NaN,i[o].push(r)}}var l=new AnkaScalable.GeomDataHolder(this.__typeClass,i,e);l.setStatus(AnkaScalable.GeomDataHolder.STATUS.COMPLETED),this.addToList(l)},createPolyLine:function(t,e){for(var i=[],n=t.paths,o=0;o<n.length;o++){i[o]=[];for(var a=0;a<n[o].length;a++){var s=n[o][a],r={lon:s[0],lat:s[1]};s.length>2?r.alt=s[2]:r.alt=NaN,i[o].push(r)}}var l=new AnkaScalable.GeomDataHolder(this.__typeClass,i,e);l.setStatus(AnkaScalable.GeomDataHolder.STATUS.COMPLETED),this.addToList(l)},redraw:function(t){this.visible&&(this.removeAllChildren(),this.layerInfo?this.getCurrentData():ht.prototype.redraw.apply(this,[t]))}});var Ot=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&xt(t,e)}(a,t);var e,i,n,o=Rt(a);function a(t,e,i){var n,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"geometry";return Dt(this,a),(n=o.call(this,t,"__geomKey"))._name=t,n._url=e,n.geomField=s,n._layers=i,n._viewDistance=25,n}return e=a,(i=[{key:"viewDistance",get:function(){return this._viewDistance},set:function(t){"number"==typeof t?t>1&&t<120?this._viewDistance=t:console.warn("view distance can be between 1 - 120"):console.warn("viewDistance can be only number")}},{key:"setUserParams",value:function(t){this._userParams=t}},{key:"setScalable",value:function(t){Ct(Gt(a.prototype),"setScalable",this).call(this,t),t.getBasePano().addEvent(AnkaPanAPI.PanoGLV2.LOCATION_CHANGE,this,this.refreshData)}},{key:"cleanAllGeomDataHolderData",value:function(){this.removeAll()}},{key:"refreshData",value:function(){var t=this;if(this.visible){this.cleanAllGeomDataHolderData();var e=this.getData();e&&e.then((function(e){var i=e.features;if(i)for(var n=0;n<i.length;n++){var o=i[n],a=AnkaScalable.GeomDataHolder.fromGeoJSON(o);a?t.addToLocal(a):console.warn("Type could not be found")}t.redraw(!1)}))}}},{key:"getData",value:function(){var t=this,e=this.scalable.baseObject.getCurrentPoint();if(e){var i=e.lat,n=e.lon,o=this.viewDistance,a=AnkaPanAPI.Utils,s=a.destinationPoint(i,n,o,90).lon,r=a.destinationPoint(i,n,o,270).lon,l=a.destinationPoint(i,n,o,0).lat,h=a.destinationPoint(i,n,o,180).lat,c="".concat(r,",").concat(h,",").concat(s,",").concat(l,",EPSG:4326"),u={service:"WFS",version:"1.0.0",request:"GetFeature",outputFormat:"application/json",typeName:this._layers,propertyName:"*",bbox:c};this._userParams&&(u=Object.assign(u,this._userParams));var p=[];for(var f in u){var d=u[f];p.push("".concat(f,"=").concat(d))}var y=this._url+"?"+p.join("&");return AnkaPanAPI.AnkaFetch(y).then((function(t){return t.json()}))}console.log("Panorama is not found, will refresh in ".concat(1)),setTimeout((function(){return t.refreshData()}),1e3)}},{key:"redraw",value:function(t){this.removeAllChildren(),this.visible&&(t?this.refreshData():Ct(Gt(a.prototype),"redraw",this).call(this))}}])&&Ht(e.prototype,i),n&&Ht(e,n),Object.defineProperty(e,"prototype",{writable:!1}),a}(ht);function kt(t,e){if(T.apply(this,arguments),this.type="HLine",this.points=[],this.scalable=t,this.softText=t.softText,this.hypotenuseHook=new THREE.Object3D,this.degreeHook=new THREE.Object3D,this.neighbourHook=new THREE.Object3D,this.oppositeHook=new THREE.Object3D,this.__hooks=[this.hypotenuseHook,this.degreeHook,this.neighbourHook,this.oppositeHook],this.neighbourSize=0,!kt.__hookTexture){var i=AnkaPanAPI.AssetManager.getInstance().GetAssetNoCache("img/scalable/hook.jpg");i.generateMipmaps=!1,i.minFilter=THREE.LinearFilter,kt.__hookTexture=i}if(!kt.__hookGeom){var n=new THREE.Geometry,o=new THREE.Vector3;n.vertices.push(o),kt.__hookGeom=n}this.hypotenusCenter={x:0,y:0,z:0},this.opposideCenter={x:0,y:0,z:0},this.neighbourCenter={x:0,y:0,z:0},this._lineColor=new THREE.Color(1,0,1);var a=new THREE.LineBasicMaterial({color:this._lineColor,linewidth:1,depthTest:!0,transparent:!0,depthWrite:!1});this.hookGeom=kt.__hookGeom;var s=new THREE.PointsMaterial({size:8,sizeAttenuation:!1,map:kt.__hookTexture,depthTest:!0,color:65280,transparent:!1}),r=new THREE.PointsMaterial({size:8,sizeAttenuation:!1,map:kt.__hookTexture,depthTest:!0,color:16711680,transparent:!1});this.hookMaterial=s,this.bottomHook=new THREE.Points(this.hookGeom,this.hookMaterial),this.add(this.bottomHook),this.topHook=new THREE.Points(this.hookGeom,r),this.add(this.topHook);var l=2;this.range=l;var h=new THREE.BufferGeometry,c=new Float32Array(3*l);h.addAttribute("position",new THREE.BufferAttribute(c,3)),this.line=new D(h,a),this.line.frustumCulled=!1,this.add(this.line);var u=new THREE.BufferGeometry,p=new Float32Array(3*l);u.addAttribute("position",new THREE.BufferAttribute(p,3));var f=new THREE.LineDashedMaterial({color:16776960,dashSize:3,gapSize:1,linewidth:2});this.neighbourEdge=new THREE.Line(u,f),this.add(this.neighbourEdge),this.neighbourEdge.frustumCulled=!1;var d=new THREE.BufferGeometry,y=new Float32Array(3*l);d.addAttribute("position",new THREE.BufferAttribute(y,3));var m=new THREE.LineDashedMaterial({color:16777215,dashSize:3,gapSize:1,linewidth:2});this.oppositeEdge=new THREE.Line(d,m),this.add(this.oppositeEdge),this.oppositeEdge.frustumCulled=!1,this._raycasterForMouse=new THREE.Raycaster,this._mousePos=new THREE.Vector3}Ot.TYPES={POINT:"POINT"},kt.isMultiGeom=!1,kt.prototype=Object.assign(Object.create(T.prototype),{constructor:kt,enable:function(t){if(!this.enabled){this.openGeom=!0,this.panogl=t;var e=t.getMainCamera();this.canDraw=!0,this.line.setClickable(!0,this.panogl,null,e),this.line.addEvent(T.CLICK,this,this.onClick),this.line.addEvent(T.MOUSE_DOWN,this,this.onDown)}},stopDraw:function(){this.line.frustumCulled=!0,this.line.geometry.computeBoundingSphere()},onClick:function(t){t.currentTarget=this,this.throwEvent(t)},onSelect:function(){this.line.material.color=new THREE.Color(0,1,1)},onDeSelect:function(){this.updateStyle()},setData:function(t,e){if(t.length>0){if(this.attributes=e,1===t.length){var i=t[0];this.points[0]=i}else this.points=[t[0],t[1]];if(this.bottomHook.visible=!0,this.bottomHook.position.set(0,0,0),2===this.points.length){var n=50*(this.points[1].alt-this.points[0].alt);n>0?(this.bottomHook.position.set(0,0,0),this.topHook.position.set(0,n,0)):(this.bottomHook.position.set(0,-n,0),this.topHook.position.set(0,0,0))}}else this.points.length=0},getRayDirection:function(){var t=this.panogl.getMainCamera(),e=this.panogl.globalMouseOffsetX,i=this.panogl.globalMouseOffsetY,n=this.panogl.getRendererDom();return this._mousePos.x=e/n.width*2-1,this._mousePos.y=-i/n.height*2+1,this._raycasterForMouse.setFromCamera(this._mousePos,t),this._raycasterForMouse.ray.direction},setDynamicPoint:function(t){if(this.points.length>0){var e=t;this.points[1]={lat:e.lat,lon:e.lon,alt:e.alt}}},getHeightInMeter:function(){return this.attributes.__hightInMeter},update:function(){if(!(this.points.length<2)){var t=this.line.geometry,e=t.attributes.position.array,i=this.points[0],n=this.scalable.calculatePointPositionFromLonLatAlt(i.lon,i.lat,i.alt);i=this.points[1];var o=this.scalable.calculatePointPositionFromLonLatAlt(i.lon,i.lat,i.alt),a=this.points[0].alt,s=this.points.length>1?this.points[1].alt:this.points[0].alt;if(n.y>o.y){var r=n;n=o,o=r,this.attributes.__hightInMeter=a-s}else this.attributes.__hightInMeter=s-a;e[0]=0,e[1]=0,e[2]=0,e[3]=o.x-n.x,e[4]=o.y-n.y,e[5]=o.z-n.z,this.position.set(n.x,n.y,n.z),t.setDrawRange(0,this.range),t.attributes.position.needsUpdate=!0;var l=this.neighbourEdge.geometry.attributes.position.array;l[0]=e[0],l[1]=e[1],l[2]=e[2],l[3]=e[3],l[4]=e[1],l[5]=e[5],this.neighbourEdge.geometry.setDrawRange(0,this.range),this.neighbourEdge.geometry.attributes.position.needsUpdate=!0;var h=e[0]-e[3],c=e[2]-e[5],u=Math.atan2(c,h)+Math.PI,p=Math.sqrt(c*c+h*h)/2;this.neighbourCenter.x=p*Math.cos(u),this.neighbourCenter.z=p*Math.sin(u),this.neighbourCenter.y=0,this.hypotenusCenter.x=this.neighbourCenter.x,this.hypotenusCenter.z=this.neighbourCenter.z,this.hypotenusCenter.y=e[1]+(e[4]-e[1])/2;var f=AnkaPanAPI.Utils.haversine(this.points[0].lat,this.points[1].lat,this.points[0].lon,this.points[1].lon);if(this.neighbourSize=f,f<.02)this.oppositeEdge.visible=!1,this.neighbourCenter.visible=!1;else{this.neighbourCenter.visible=!0,this.oppositeEdge.visible=!0;var d=this.oppositeEdge.geometry.attributes.position.array;d[0]=e[3],d[1]=e[4],d[2]=e[5],d[3]=e[3],d[4]=e[1],d[5]=e[5],this.oppositeEdge.geometry.setDrawRange(0,this.range),this.oppositeEdge.geometry.attributes.position.needsUpdate=!0,this.opposideCenter.x=d[0],this.opposideCenter.y=d[1]+(d[4]-d[1])/2,this.opposideCenter.z=d[2]}this.centroid=this.position.y+(e[4]-e[1]),this.setLabel(),this.panogl.setDirty()}},updateStyle:function(){if(this.__layer){var t=this.__layer.getStyle();this.line.material.color=new THREE.Color(t.lineColor),this.line.material.opacity=t.lineOpacity*this.getOpacity()}},setLabel:function(){if(this.softText.removeObject3D(this.hypotenuseHook),this.softText.removeObject3D(this.degreeHook),this.softText.removeObject3D(this.neighbourHook),this.softText.removeObject3D(this.oppositeHook),this.points.length>0){var t=this.panogl.getMainCamera(),e=this.neighbourSize,i=(e=Math.round(100*e)/100)+"m",n=Math.atan(this.attributes.__hightInMeter/this.neighbourSize),o=this.attributes.__hightInMeter/Math.sin(n);o=Math.round(100*o)/100,n=Math.round(180*n/Math.PI);var a=this._commonGeom;a.attributes._length=Math.round(100*this.attributes.__hightInMeter)/100+"m";var s=this.getLabelText();if(a.attributes._slope=n,a.attributes._opposite=s,a.attributes._adjacent=this.neighbourSize,this.softText.addObject3D(this.hypotenuseHook,t,o+"m"),this.hypotenuseHook.position.set(this.hypotenusCenter.x,this.hypotenusCenter.y,this.hypotenusCenter.z),this.add(this.hypotenuseHook),this.oppositeEdge.visible){var r=this.opposideCenter;this.oppositeHook.position.set(r.x,.9*r.y,r.z),this.add(this.oppositeHook),this.softText.addObject3D(this.oppositeHook,t,s)}this.neighbourCenter.visible&&(this.neighbourHook.position.set(this.neighbourCenter.x,this.neighbourCenter.y,this.neighbourCenter.z),this.add(this.neighbourHook),this.softText.addObject3D(this.neighbourHook,t,i),this.degreeHook.position.set(this.position.x,this.position.y,this.position.z),this.add(this.degreeHook),this.softText.addObject3D(this.degreeHook,t,n+"°"))}},destroy:function(){for(var t=0;t<this.__hooks.length;t++)this.__hooks[t]&&(this.softText.removeObject3D(this.__hooks[t]),this.__hooks[t].parent&&this.__hooks[t].parent.remove(this.__hooks[t]));this.topHook&&this.remove(this.topHook),this.bottomHook&&(this.remove(this.bottomHook),this.bottomHook.material.dispose()),this.line&&(this.line.material&&this.line.material.dispose(),this.line.geometry&&this.line.geometry.dispose(),this.line.setClickable(!1)),this.neighbourEdge&&(this.neighbourEdge.material.dispose(),this.oppositeEdge.material.dispose(),this.neighbourEdge.geometry.dispose(),this.oppositeEdge.geometry.dispose(),this.neighbourEdge.parent.remove(this.neighbourEdge),this.oppositeEdge.parent.remove(this.oppositeEdge)),this.parent&&this.parent.remove(this)}})}])}));